# test/ — Interpreter Test Suite

> Generated by Claude Opus 4.6

.ksc インタプリタの自動テストとデモスクリプト。Vitest で実行。

## 実行方法

```bash
npm test          # 全テスト実行
npm run demo      # コンソールデモ実行（test/demo.ts）
```

## テストファイル一覧

### 基本機能テスト

| ファイル | テスト内容 |
|---|---|
| **Interpreter.test.ts** | インタプリタの基本動作。スクリプトの読み込み・実行・終了、セリフブロック表示、組み込みコマンド（`bg`, `ch`, `bgm`, `se`, `wait`）の呼び出し確認。IEngineAPI のモック実装を使用。 |
| **Parser.test.ts** | 構文パーサーのユニットテスト。行分類（LineType）の正確性、セリフブロック検出、ラベルインデックス構築、コメント・空行のスキップ、不正な構文のエラー検出。 |

### フェーズ別機能テスト

| ファイル | テスト内容 |
|---|---|
| **Phase2.test.ts** | ラベルとジャンプ。`*label` 定義、`jump("label")` による制御フロー移動、`call("label")` / `ret()` によるサブルーチン呼び出しとリターン、コールスタックの正しいネスト管理。 |
| **Phase3.test.ts** | 変数と式評価。変数の宣言・代入（`=`, `+=`, `-=`, `*=`）、算術演算（`+`, `-`, `*`, `/`, `%`）、比較演算（`>=`, `<=`, `>`, `<`, `==`, `!=`）、論理演算（`&&`, `\|\|`）、文字列結合、文字列補間 `{変数名}`、複雑な式の優先順位。 |
| **Phase4.test.ts** | if 文と選択肢。`if (条件) { } else { }` ブロック、ネストした条件分岐、`choice { }` ブロック、条件付き選択肢 `"テキスト" if (条件) { }`、選択肢内でのジャンプ・変数操作。 |
| **Phase5.test.ts** | 関数とサブルーチン。`def` による関数定義と `return` 値、`sub` によるサブルーチン定義、引数の受け渡し、ローカルスコープ、関数のネスト呼び出し。**注意: 再帰テスト（fibonacci）はハングする既知の問題あり。** |
| **Phase6.test.ts** | フラグシステムとインベントリ。ゲーム進行フラグの設定・参照、アイテム管理、状態の永続化。 |
| **PhaseA.test.ts** | 総合テスト。複数フェーズの機能を組み合わせた複合シナリオ。変数 + 条件分岐 + 選択肢 + 関数呼び出しを一連のフローで実行し、最終状態を検証。 |

### 統合テスト

| ファイル | テスト内容 |
|---|---|
| **Integration.test.ts** | 完全なシナリオの通し実行テスト。`examples/04-full-scenario.ksc` 等のサンプルスクリプトをインタプリタに通し、エンドツーエンドの動作を検証。 |
| **IntegrationSimple.test.ts** | 軽量な統合テスト。短いスクリプト片を使った統合テスト。各コマンドの組み合わせが正しく動作することを効率よく確認。 |

### デバッグ機能テスト

| ファイル | テスト内容 |
|---|---|
| **Debug.test.ts** | デバッグシステムのテスト。ブレークポイントの設定・削除・トリガー、変数ウォッチの登録・値変化通知、デバッグイベントのコールバック。 |
| **ErrorHandling.test.ts** | エラーハンドリングのテスト。未定義変数の参照エラー、Levenshtein 距離による変数名修正候補の提示精度、スタックトレースの正確性、エラーコンテキストの表示。 |

### デモ・ユーティリティ

| ファイル | テスト内容 |
|---|---|
| **demo.ts** | コンソールデモ。`npm run demo` で実行。`examples/01-hello.ksc` を読み込み、DemoEngineAPI（IEngineAPI のコンソール実装）を使ってターミナル上でスクリプトを実行する。セリフ、背景変更、キャラクター表示、BGM/SE 再生がコンソールに出力される。 |
| **debug-phase2.ts** | Phase 2 デバッグ用スクリプト。ラベル・ジャンプ機能の手動デバッグに使用。 |

## テスト結果（現在）

```
Test Files:  10+ passed
Tests:       134+ passed
```

**既知の問題:**
- `Phase5.test.ts` の再帰テスト（fibonacci）がハングする場合がある
- `Integration.test.ts` の大規模シナリオがタイムアウトする場合がある

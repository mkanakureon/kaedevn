# src/ — Interpreter Source Code

> Generated by Claude Opus 4.6

.ksc (Kaede Script) インタプリタのソースコード。外部依存なし、純粋な TypeScript で実装。

## ディレクトリ構成

```
src/
├── index.ts              — パッケージエントリポイント（全 export）
├── core/                 — インタプリタコアエンジン
│   ├── Interpreter.ts    — メインインタプリタ
│   ├── Parser.ts         — 構文パーサー
│   ├── Tokenizer.ts      — 字句解析器（レキサー）
│   ├── Evaluator.ts      — 式評価器
│   └── GameState.ts      — ゲーム状態管理
├── debug/                — デバッグ機能
│   ├── Debugger.ts       — ブレークポイント・変数ウォッチ
│   └── ErrorHandler.ts   — エラーハンドリング・修正候補提示
├── engine/               — プラットフォーム抽象
│   └── IEngineAPI.ts     — エンジンインターフェース定義
└── types/                — 型定義
    ├── CallFrame.ts      — コールスタックフレーム
    ├── Choice.ts         — 選択肢ノード
    ├── Error.ts          — エラー型
    ├── LineType.ts       — 行分類 enum
    └── Token.ts          — トークン型
```

## core/ — インタプリタコアエンジン

### Interpreter.ts

インタプリタの中心。`.ksc` スクリプトを受け取り、1 行ずつ解釈・実行する。
Parser でスクリプトを構文解析し、行の種類（セリフ、コマンド、制御文、式）に応じて
適切な処理を振り分ける。IEngineAPI を通じてプラットフォーム固有の描画・音声・入力を呼び出す。

主要メソッド:
- `run(script)` — スクリプト全体を実行
- `getState()` — 現在のインタプリタ状態（PC、変数）を返す

### Parser.ts

スクリプトの各行を分類する構文パーサー。行の種類（LineType）を判定し、
セリフブロック（`#キャラ名 ... #`）の検出、ラベル（`*label`）のインデックス構築、
`if/else`・`choice` ブロックの構造解析を行う。

### Tokenizer.ts

式（expression）を字句解析してトークン列に変換するレキサー。
数値リテラル、文字列リテラル、識別子、演算子（`+`, `-`, `*`, `/`, `>=`, `==` 等）、
括弧をトークンに分割し、Evaluator に渡す。

### Evaluator.ts

再帰下降パーサー方式の式評価器。Tokenizer が生成したトークン列を受け取り、
算術演算（`+`, `-`, `*`, `/`, `%`）、比較演算（`>=`, `<=`, `>`, `<`, `==`, `!=`）、
論理演算（`&&`, `||`）、関数呼び出し、文字列補間 `{変数名}` を評価する。
変数の参照・代入は GameState を通じて行う。

### GameState.ts

インタプリタの実行状態を一元管理するクラス。以下の情報を保持する:
- **変数ストア** — スクリプト内で定義された全変数
- **コールスタック** — `call()` / `sub` / `def` のネスト管理
- **ラベルマップ** — `*label` 名から行番号への対応表
- **関数定義** — `def` / `sub` の定義情報（引数リスト、本体の行範囲）

## debug/ — デバッグ機能

### Debugger.ts

開発時のデバッグ支援システム。ブレークポイントの設定・解除、変数ウォッチ（値の変化を監視）、
実行トレースログの出力を提供する。デバッグイベントのコールバックを通じて外部ツールと連携可能。

### ErrorHandler.ts

エラー発生時に有用な情報を提供するハンドラー。Levenshtein 距離を使った変数名・ラベル名の
タイプミス候補提示、コールスタックトレースの整形出力、エラー発生箇所のコンテキスト表示を行う。
例: `affecton` と入力した場合、「`affection` のことですか？」と提案する。

## engine/ — プラットフォーム抽象

### IEngineAPI.ts

インタプリタとプラットフォーム固有処理を分離するインターフェース。
このインターフェースを実装することで、同じ `.ksc` スクリプトを Web（PixiJS）、
コンソール（Node.js）、Nintendo Switch など異なる環境で実行できる。

定義されているメソッド:
- **セリフ**: `showDialogue(speaker, lines)` — キャラクターのセリフを表示
- **背景**: `setBg(name, effect?)` — 背景画像の設定・切り替え
- **キャラクター**: `showChar()`, `hideChar()`, `moveChar()` — キャラクターの表示・非表示・移動
- **オーディオ**: `playBgm()`, `stopBgm()`, `fadeBgm()`, `playSe()` — BGM・SE 再生
- **タイムライン**: `playTimeline(name)` — カットシーン等のタイムライン再生
- **UI**: `showChoice(options)` — 選択肢表示、`waitForClick()` — クリック待ち、`wait(ms)` — 時間待ち

## types/ — 型定義

### CallFrame.ts
関数・サブルーチン・ラベル呼び出し時のコールスタックフレーム。戻り先の行番号、ローカルスコープの変数、呼び出し元の情報を保持する。

### Choice.ts
`choice { }` ブロックの構文木ノード。各選択肢のラベルテキスト、条件式（`if (条件)` 付き選択肢）、選択時に実行される本体のコマンド列を表現する。

### Error.ts
インタプリタのエラー型定義。エラーコード、発生行番号、エラーメッセージ、スタックトレース情報を含む。

### LineType.ts
スクリプトの各行を分類する enum。`Dialogue`（セリフ）、`Label`（ラベル）、`Expression`（式・コマンド）、`Comment`（コメント）、`Empty`（空行）などの種類がある。

### Token.ts
Tokenizer が生成するトークンの型定義。`Number`、`String`、`Identifier`、`Operator`、`LeftParen`、`RightParen` 等のトークン種別と、それに付随する値を持つ。

# API リファレンス

> Generated by Claude Opus 4.6

`@kaedevn/interpreter` の全エクスポートクラス・関数・型の一覧。

## 1. エクスポート一覧

```typescript
// Core classes
export { Interpreter } from "./core/Interpreter.js";
export { GameState } from "./core/GameState.js";
export { Parser } from "./core/Parser.js";
export { Tokenizer } from "./core/Tokenizer.js";
export { Evaluator } from "./core/Evaluator.js";

// Engine API
export type { IEngineAPI, ChoiceOption } from "./engine/IEngineAPI.js";
export { ConsoleEngine } from "./engine/ConsoleEngine.js";
export type { ConsoleEngineOptions } from "./engine/ConsoleEngine.js";

// Types
export { LineType } from "./types/LineType.js";
export { TokenType } from "./types/Token.js";
export type { Token } from "./types/Token.js";
export type { CallFrame } from "./types/CallFrame.js";
export type { ChoiceNode, ChoiceOptionNode } from "./types/Choice.js";
export type { FunctionDef } from "./core/GameState.js";
```

## 2. Interpreter

```typescript
class Interpreter {
  constructor(engine: IEngineAPI, options?: { debug?: boolean });
  run(script: string): Promise<void>;
  stop(): void;
  jumpTo(label: string): void;
  getState(): { pc: number; variables: Record<string, unknown>; callStack: number };
  getDebugger(): Debugger;
}
```

| メソッド | 説明 |
|---|---|
| `constructor(engine, options?)` | IEngineAPI 実装を受け取る。`debug: true` でデバッグモード有効化 |
| `run(script)` | .ksc スクリプトを実行。完了または `stop()` まで await |
| `stop()` | 実行を停止（`running = false`） |
| `jumpTo(label)` | 指定ラベルに PC を設定（外部からの制御用） |
| `getState()` | 現在の PC、グローバル変数、コールスタック深度を返す |
| `getDebugger()` | Debugger インスタンスを取得 |

## 3. GameState

```typescript
class GameState {
  variables: Map<string, unknown>;
  localScopes: Map<string, unknown>[];
  callStack: CallFrame[];
  labelMap: Map<string, number>;
  functions: Map<string, FunctionDef>;
  subroutines: Map<string, FunctionDef>;

  getVar(name: string): unknown;
  setVar(name: string, value: unknown): void;
  setLocalVar(name: string, value: unknown): void;
  hasVar(name: string): boolean;
  pushScope(): void;
  popScope(): void;
  pushFrame(frame: CallFrame): void;
  popFrame(): CallFrame | undefined;
}
```

| メソッド | 説明 |
|---|---|
| `getVar(name)` | ローカル → グローバルの順で変数を検索 |
| `setVar(name, value)` | 既存スコープで更新、なければグローバルに作成 |
| `setLocalVar(name, value)` | 最内スコープにローカル変数を設定 |
| `hasVar(name)` | ローカル → グローバルの順で存在確認 |
| `pushScope()` | 新しいローカルスコープを作成 |
| `popScope()` | 最内ローカルスコープを削除 |
| `pushFrame(frame)` | コールスタックにフレームを追加 |
| `popFrame()` | コールスタックからフレームを取り出し |

## 4. Parser

```typescript
class Parser {
  classifyLine(line: string): LineType;
  findDialogueEnd(lines: string[], start: number): number;
  extractLabelName(line: string): string;
  extractSpeaker(line: string): string;
  findBlockEnd(lines: string[], start: number): number;
  buildLabelMap(lines: string[]): Map<string, number>;
  parseFunctionDef(lines: string[], start: number): FunctionDef;
  parseChoice(lines: string[], start: number): ChoiceNode;
}
```

| メソッド | 説明 |
|---|---|
| `classifyLine(line)` | トリム済み行を LineType に分類 |
| `findDialogueEnd(lines, start)` | セリフ終了 `#` の行番号を検索 |
| `extractLabelName(line)` | `*label` からラベル名を抽出 |
| `extractSpeaker(line)` | `#name` から話者名を抽出 |
| `findBlockEnd(lines, start)` | `{ ... }` の閉じ位置を検索 |
| `buildLabelMap(lines)` | 全ラベルの行番号マップを構築 |
| `parseFunctionDef(lines, start)` | def/sub 定義を FunctionDef に解析 |
| `parseChoice(lines, start)` | choice 構文を ChoiceNode に解析 |

## 5. Tokenizer

```typescript
class Tokenizer {
  tokenize(input: string): Token[];
}
```

| メソッド | 説明 |
|---|---|
| `tokenize(input)` | 式文字列をトークン配列に変換 |

## 6. Evaluator

```typescript
type FunctionCallHandler = (name: string, args: unknown[]) => Promise<unknown>;

class Evaluator {
  setFunctionCallHandler(handler: FunctionCallHandler): void;
  evaluate(expr: string, state: GameState): Promise<unknown>;
  executeAssignment(expr: string, state: GameState): Promise<void>;
  evaluateCondition(expr: string, state: GameState): Promise<boolean>;
  interpolate(text: string, state: GameState): Promise<string>;
}
```

| メソッド | 説明 |
|---|---|
| `setFunctionCallHandler(handler)` | 式内の関数呼び出しハンドラーを設定 |
| `evaluate(expr, state)` | 式を評価して結果を返す |
| `executeAssignment(expr, state)` | 代入文（`x = 5`, `y += 3`）を実行 |
| `evaluateCondition(expr, state)` | 条件式を評価して boolean を返す |
| `interpolate(text, state)` | テキスト内の `{式}` を評価して置換 |

## 7. 型定義

### LineType

```typescript
enum LineType {
  DialogueStart = "DialogueStart",
  DialogueEnd   = "DialogueEnd",
  Label         = "Label",
  Comment       = "Comment",
  Empty         = "Empty",
  Expression    = "Expression",
}
```

### TokenType

```typescript
enum TokenType {
  Number      = "Number",
  String      = "String",
  Boolean     = "Boolean",
  Identifier  = "Identifier",
  Operator    = "Operator",
  Assign      = "Assign",
  LeftParen   = "LeftParen",
  RightParen  = "RightParen",
  LeftBrace   = "LeftBrace",
  RightBrace  = "RightBrace",
  Comma       = "Comma",
  Keyword     = "Keyword",
}
```

### Token

```typescript
interface Token {
  type: TokenType;
  value: string;
  position: number;
}
```

### CallFrame

```typescript
interface CallFrame {
  returnPc: number;
  scopeDepth: number;
  kind: "label" | "function" | "subroutine" | "method";
  returnVar?: string;
  thisRef?: unknown;
  source?: {
    line: number;
    name: string;
  };
}
```

### FunctionDef

```typescript
interface FunctionDef {
  name: string;
  params: string[];
  bodyStart: number;
  bodyEnd: number;
}
```

### ChoiceNode / ChoiceOptionNode

```typescript
interface ChoiceNode {
  options: ChoiceOptionNode[];
  end: number;
}

interface ChoiceOptionNode {
  text: string;
  condition?: string;
  bodyStart: number;
  bodyEnd: number;
}
```

### ConsoleEngine

```typescript
class ConsoleEngine implements IEngineAPI {
  constructor(options?: ConsoleEngineOptions);
}

interface ConsoleEngineOptions {
  defaultChoice?: number;           // showChoice の自動選択（デフォルト: 0）
  defaultBattleResult?: "win" | "lose";  // battleStart の結果（デフォルト: "win"）
  realTime?: boolean;               // wait() を実時間で待機（デフォルト: false）
  output?: (message: string) => void;    // 出力先（デフォルト: console.log）
}
```

IEngineAPI の公式コンソール実装。全17メソッドを標準出力のテキストに変換する。詳細は [guide-console-engine.md](guide-console-engine.md) を参照。

### IEngineAPI

```typescript
interface IEngineAPI {
  showDialogue(speaker: string, lines: string[]): Promise<void>;
  setBg(name: string, effect?: string): Promise<void>;
  showChar(name: string, pose: string, position?: string, fadeMs?: number): Promise<void>;
  showCharAnim(name: string, pose: string, position: string): Promise<void>;
  hideChar(name: string, fadeMs?: number): Promise<void>;
  clearChars(fadeMs?: number): Promise<void>;
  moveChar(name: string, position: string, time: number): Promise<void>;
  playBgm(name: string, vol?: number, fadeMs?: number): void;
  stopBgm(): void;
  fadeBgm(time: number): Promise<void>;
  playSe(name: string, vol?: number): void;
  playVoice(name: string): void;
  playTimeline(name: string): Promise<void>;
  battleStart(troopId: string): Promise<'win' | 'lose'>;
  showChoice(options: ChoiceOption[]): Promise<number>;
  waitForClick(): Promise<void>;
  wait(ms: number): Promise<void>;
}

interface ChoiceOption {
  text: string;
  condition?: boolean;
}
```

### ErrorType / KNFError

```typescript
enum ErrorType {
  SyntaxError    = "SyntaxError",
  ReferenceError = "ReferenceError",
  TypeError      = "TypeError",
  RuntimeError   = "RuntimeError",
  StackOverflow  = "StackOverflow",
  FileNotFound   = "FileNotFound",
}

interface KNFError {
  type: ErrorType;
  message: string;
  line: number;
  column?: number;
  stack: Array<{ functionName: string; line: number; column?: number }>;
  suggestions?: string[];
  context?: string;
}
```

### Debugger 関連型

```typescript
interface BreakpointInfo {
  line: number;
  condition?: string;
  enabled: boolean;
}

enum DebugEventType {
  VariableChanged = "variable_changed",
  Breakpoint      = "breakpoint",
  StepComplete    = "step_complete",
  FunctionCall    = "function_call",
  FunctionReturn  = "function_return",
}

interface DebugEvent {
  type: DebugEventType;
  line: number;
  data?: unknown;
}

interface VariableChange {
  line: number;
  oldValue: unknown;
  newValue: unknown;
  timestamp: number;
}
```

> 注: Debugger クラスと ErrorHandler クラスは `index.ts` からエクスポートされていないが、`Interpreter.getDebugger()` 経由で Debugger インスタンスにアクセス可能。

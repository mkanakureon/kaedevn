# 式評価仕様書

> Generated by Claude Opus 4.6

## 1. 概要

式評価は Tokenizer（字句解析）→ Evaluator（構文解析＋評価）の 2 段階で行われる。Evaluator は再帰下降パーサーとして実装されており、トークン列を優先順位に従って評価する。

## 2. Tokenizer

ソース: `src/core/Tokenizer.ts`

### 2.1 トークン種別

| TokenType | 説明 | 例 |
|---|---|---|
| `Number` | 数値リテラル | `42`, `3.14` |
| `String` | 文字列リテラル | `"hello"`, `'world'` |
| `Boolean` | 真偽値リテラル | `true`, `false` |
| `Identifier` | 識別子（変数名、関数名） | `score`, `hero` |
| `Operator` | 演算子 | `+`, `-`, `==`, `&&` |
| `Assign` | 代入演算子 | `=`, `+=`, `-=`, `*=`, `/=` |
| `LeftParen` | 左括弧 | `(` |
| `RightParen` | 右括弧 | `)` |
| `LeftBrace` | 左ブレース | `{` |
| `RightBrace` | 右ブレース | `}` |
| `Comma` | カンマ | `,` |
| `Keyword` | 予約語 | `if`, `def`, `return` |

### 2.2 トークン構造

```typescript
interface Token {
  type: TokenType;
  value: string;
  position: number;  // 入力文字列内の開始位置
}
```

### 2.3 字句解析ルール

1. **空白スキップ**: 空白文字（スペース、タブ、改行）は無視
2. **数値**: `0-9` で始まる連続した数字。小数点 `.` を含む場合は浮動小数点
3. **文字列**: `"` または `'` で囲まれた文字列。エスケープシーケンス対応
4. **識別子**: `a-z`, `A-Z`, `_` で始まり、`a-z`, `A-Z`, `0-9`, `_` が続く
5. **キーワード判定**: 識別子が予約語リストに含まれる場合は `Keyword`。`true` / `false` は `Boolean`
6. **2 文字演算子**: `+=`, `-=`, `*=`, `/=`, `==`, `!=`, `>=`, `<=`, `&&`, `||`
7. **1 文字演算子**: `+`, `-`, `*`, `/`, `%`, `>`, `<`, `!`, `=`

### 2.4 エスケープシーケンス

文字列内で認識されるエスケープ：

| 入力 | 出力 |
|---|---|
| `\n` | 改行 |
| `\t` | タブ |
| `\\` | `\` |
| `\"` | `"` |
| `\'` | `'` |
| その他 | そのまま出力 |

## 3. Evaluator

ソース: `src/core/Evaluator.ts`

### 3.1 再帰下降パーサー構造

```
parseExpression()
  └─ parseLogicOr()
       └─ parseLogicAnd()
            └─ parseEquality()
                 └─ parseComparison()
                      └─ parseAddition()
                           └─ parseMultiplication()
                                └─ parseUnary()
                                     └─ parsePrimary()
```

### 3.2 演算子優先順位と結合性

| 優先度 | メソッド | 演算子 | 結合性 |
|---|---|---|---|
| 1（低） | `parseLogicOr` | `\|\|` | 左 |
| 2 | `parseLogicAnd` | `&&` | 左 |
| 3 | `parseEquality` | `==`, `!=` | 左 |
| 4 | `parseComparison` | `>`, `>=`, `<`, `<=` | 左 |
| 5 | `parseAddition` | `+`, `-` | 左 |
| 6 | `parseMultiplication` | `*`, `/`, `%` | 左 |
| 7（高） | `parseUnary` | `!`, `-`（単項） | 右 |

### 3.3 parsePrimary の処理

`parsePrimary` はトークン種別に応じて以下を返す：

| トークン種別 | 処理 |
|---|---|
| `Number` | `parseFloat(token.value)` |
| `String` | `token.value`（クォート除去済み） |
| `Boolean` | `token.value === "true"` |
| `Identifier` + `(` | 関数呼び出し（`functionCallHandler` を使用） |
| `Identifier` | 変数参照（`state.getVar(name)`、未定義でエラー） |
| `LeftParen` | グループ化（`( expr )`） |

## 4. 型強制ルール

### 4.1 加算 (`+`)

```
string + any → String(left) + String(right)
any + string → String(left) + String(right)
number + number → left + right
```

### 4.2 減算・乗算・除算・剰余 (`-`, `*`, `/`, `%`)

両辺を `number` としてキャスト。型チェックは行わない。

### 4.3 比較 (`>`, `>=`, `<`, `<=`)

両辺を `number` としてキャスト。型チェックは行わない。

### 4.4 等価 (`==`, `!=`)

JavaScript の `===` / `!==` で厳密比較。型変換なし。

### 4.5 論理演算 (`&&`, `||`)

truthy/falsy 判定を使用。結果は `boolean` 値。

### 4.6 除算ゼロ

`/` または `/=` で右辺が 0 の場合、`"0除算エラー"` をスロー。

## 5. 関数呼び出し

### 5.1 式内の関数呼び出し

Evaluator の `parsePrimary` で `Identifier` の次が `(` の場合、関数呼び出しとして処理：

1. `(` を消費
2. 引数を `,` 区切りで `parseExpression` して収集
3. `)` を確認
4. `functionCallHandler(name, args)` を呼び出し

### 5.2 関数呼び出しハンドラー

`Evaluator.setFunctionCallHandler()` でハンドラーを設定する。Interpreter のコンストラクタで以下のハンドラーが設定される：

- ユーザー定義関数/サブルーチン → `executeUserFunction` で実行
- 組み込み関数 → エラー（式の中では使用不可）
- 未定義関数 → エラー（Levenshtein 距離で候補を提案）

## 6. 代入処理

`Evaluator.executeAssignment()` は代入文を処理する：

1. 左辺の変数名を取得（`Identifier` トークン）
2. 代入演算子を取得（`=`, `+=`, `-=`, `*=`, `/=`）
3. 右辺の式を評価
4. 演算子に応じて変数に値を設定

複合代入（`+=` 等）で未定義変数を参照する場合、初期値 `0` を使用。

## 7. 条件評価

`Evaluator.evaluateCondition()` は式を評価した後、結果を truthy/falsy 判定して `boolean` を返す。

## 8. 文字列補間

`Evaluator.interpolate()` はテキスト内の `{式}` パターンを検出し、各式を評価して置換する。

処理フロー：
1. 正規表現 `/\{([^}]+)\}/g` で全マッチを収集
2. 後ろから順に置換（インデックスのずれ防止）
3. 式の評価結果を文字列に変換（null/undefined は空文字列）
4. 評価エラーは即座にスロー

## 9. エラー時の挙動

| エラー | 発生条件 | メッセージ |
|---|---|---|
| 未定義変数 | `state.hasVar(name)` が false | `未定義の変数: {name}` |
| 未定義関数 | ハンドラーで解決不可 | `未定義の関数: {name}`（候補提案付き） |
| 括弧不一致 | `)` がない | `閉じ括弧 ')' がありません` |
| 関数括弧不一致 | 関数呼び出しの `)` がない | `関数呼び出しの閉じ括弧 ')' がありません` |
| 予期しないトークン | パースできない | `予期しないトークン: {value}` |
| 除算ゼロ | 除数が 0 | `0除算エラー` |
| 代入左辺エラー | 左辺が識別子でない | `代入の左辺は変数名である必要があります` |
| ハンドラー未設定 | 式内関数呼び出しでハンドラーなし | `式の中での関数呼び出しにはハンドラーが必要です` |

## 10. 再帰呼び出しの上限

関数・サブルーチンの再帰呼び出しは最大 16 段まで。超過時は `再帰呼び出しの深度が上限（16）を超えました` エラー。

深度カウントは `callStack` 内の `kind === "function" || kind === "subroutine"` のフレーム数で判定する。

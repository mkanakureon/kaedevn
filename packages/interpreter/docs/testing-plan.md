# テスト計画書

> Generated by Claude Opus 4.6

## 1. テスト戦略

### 1.1 テストレベル

| レベル | 対象 | ツール |
|---|---|---|
| **ユニットテスト** | 各クラスのメソッド単位 | Vitest |
| **統合テスト** | 複数クラスの連携 | Vitest + MockEngine |
| **E2E テスト** | 完全なスクリプト実行 | Vitest + MockEngine |

### 1.2 テスト方針

- 各フェーズ（Phase 1–7）に対応するテストファイルを配置
- MockEngine でコマンド呼び出しとセリフ表示を記録
- `expect` で期待する状態を明確に検証
- スキップ・フォールバック・エラー握りつぶしは禁止

## 2. テスト対象範囲

### 2.1 対象モジュール

| モジュール | テストファイル | カバー範囲 |
|---|---|---|
| Parser | `Parser.test.ts` | 行分類、ラベルマップ構築、ブロック検索 |
| Interpreter (基本) | `Interpreter.test.ts` | 基本実行、セリフ、コマンド |
| Phase 2 (jump/call/ret) | `Phase2.test.ts` | ラベル、ジャンプ、サブルーチン |
| Phase 3 (変数・式) | `Phase3.test.ts` | 変数代入、算術演算、式評価 |
| Phase 4 (if/choice) | `Phase4.test.ts` | 条件分岐、選択肢 |
| Phase 5 (関数) | `Phase5.test.ts` | def/sub、引数、戻り値、再帰 |
| Phase 6 (補間) | `Phase6.test.ts` | 文字列補間 |
| エラーハンドリング | `ErrorHandling.test.ts` | エラー種別、修正候補、スタックトレース |
| デバッグ | `Debug.test.ts` | ブレークポイント、変数ウォッチ、トレースログ |
| 統合 | `Integration.test.ts` | 全機能統合シナリオ |
| 統合（簡易） | `IntegrationSimple.test.ts` | 簡易統合テスト |
| Phase A | `PhaseA.test.ts` | 追加テスト |

### 2.2 対象外

- IEngineAPI の具体的なプラットフォーム実装（Web/Switch）
- ファイル I/O（スクリプトの読み込み自体）
- パフォーマンスベンチマーク（一部テストで簡易計測のみ）

## 3. テスト環境

| 項目 | 値 |
|---|---|
| テストフレームワーク | Vitest 1.2+ |
| ランタイム | Node.js 20+ |
| TypeScript | 5.3+ |
| モック | MockEngine（手動実装） |

## 4. テストデータ

### 4.1 インラインスクリプト

ほとんどのテストはテストコード内にスクリプトをインラインで記述:

```typescript
const script = `
x = 10
y = 20
z = x + y
`;
await interpreter.run(script);
```

### 4.2 外部スクリプト

`examples/` ディレクトリのデモスクリプトを使用する統合テストあり（一部 skip）:
- `examples/04-full-scenario.ksc` — 完全なデモシナリオ

## 5. 合格基準

| 基準 | 値 |
|---|---|
| 全テスト通過 | 必須 |
| テストケース数 | 134+ |
| パフォーマンス | 100 変数操作: 500ms 以内 |
| エラー検出 | 全エラー種別でテストあり |

## 6. 既知の問題と対応方針

| 問題 | 状態 | 対応 |
|---|---|---|
| Phase 5 再帰テストのハング | **既知** | fibonacci 等の再帰テストは skip |
| 大規模ループのタイムアウト | **既知** | 100 回ループテストは skip |
| デモシナリオの外部ファイル依存 | **既知** | 外部ファイルテストは skip |
| `while` 構文の未実装 | **仕様** | テスト対象外 |

## 7. テストスケジュール

| フェーズ | テスト内容 | 状態 |
|---|---|---|
| Phase 1 | Parser、行分類、基本構造 | 完了 |
| Phase 2 | ラベル、jump/call/ret | 完了 |
| Phase 3 | 変数、式評価、算術演算 | 完了 |
| Phase 4 | if/else if/else、choice | 完了 |
| Phase 5 | def/sub、引数、戻り値 | 完了（再帰 skip） |
| Phase 6 | 文字列補間 | 完了 |
| Phase 7-1 | エラーハンドリング | 完了 |
| Phase 7-2 | デバッグモード | 完了 |
| Phase 7-3 | 統合テスト | 完了（一部 skip） |

# 変更履歴

> Generated by Claude Opus 4.6

## v0.1.0 — Phase 1〜7 完成 (2026-02-09)

### Phase 7-3: 統合テスト・デモシナリオ

- 統合テスト追加（全機能を使用するシナリオ）
- パフォーマンステスト（100 変数操作: 500ms 以内）
- デバッグモード統合テスト
- デモスクリプト (`test/demo.ts`)

### Phase 7-2: デバッグモード

- `Debugger` クラスの実装
- ブレークポイント管理（行指定、条件付き）
- 変数ウォッチ機能（変更履歴の記録）
- ステップ実行制御（over/into/out）
- トレースログ（関数呼び出し・変数変更の記録）
- デバッグイベントシステム（`addEventListener`）
- `Interpreter` のコンストラクタに `debug` オプション追加
- 代入処理で変数変更を Debugger に通知

### Phase 7-1: エラーハンドリング

- `ErrorHandler` クラスの実装
- エラー種別の定義（`ErrorType` enum）
- `KNFError` 構造体（種別、行番号、スタックトレース、修正候補、コンテキスト）
- Levenshtein 距離による類似変数名・関数名の提案
- スタックトレースのフォーマット
- エラーコンテキスト生成（該当行の前後表示）
- `Interpreter.enhanceEvaluatorError()` で未定義変数エラーを拡張
- `Interpreter.buildErrorStack()` でスタックトレース構築

### Phase 6: 文字列補間

- `Evaluator.interpolate()` の実装
- セリフブロック内の `{式}` を評価結果に置換
- 補間エラーで実行停止
- null/undefined は空文字列に置換

### Phase 5: 関数・サブルーチン

- `def` 関数定義と呼び出し（戻り値あり）
- `sub` サブルーチン定義と呼び出し（戻り値なし）
- 引数の束縛とローカルスコープ
- `return` 文の処理
- 再帰呼び出し（深度上限: 16 段）
- 組み込み関数名の予約語チェック
- `sub` 内の `return expr` 禁止
- Evaluator の非同期化（`async` 対応）
- `FunctionCallHandler` によるハンドラーパターン
- `Parser.parseFunctionDef()` の実装

**破壊的変更:**
- `Evaluator.evaluate()` が `Promise<unknown>` を返すようになった（同期 → 非同期）
- `Evaluator.evaluateCondition()` が `Promise<boolean>` を返すようになった

### Phase 4: 条件分岐・選択肢

- `if` / `else if` / `else` 構文の実装
- `choice` 構文の実装
- 条件付き選択肢（`if (条件)` 付き）
- ネストされた if 文のサポート
- ブロック内でのセリフ・コマンド実行
- `Parser.parseChoice()` の実装
- 表示可能な選択肢が 0 件の場合のエラー

### Phase 3: 変数・式評価

- `Tokenizer` クラスの実装（字句解析）
- `Evaluator` クラスの実装（再帰下降パーサー）
- 数値・文字列・真偽値リテラル
- 算術演算子（`+`, `-`, `*`, `/`, `%`）
- 比較演算子（`==`, `!=`, `>`, `>=`, `<`, `<=`）
- 論理演算子（`&&`, `||`, `!`）
- 代入演算子（`=`, `+=`, `-=`, `*=`, `/=`）
- 文字列結合（`string + any`）
- 括弧によるグループ化
- 0 除算エラー
- 未定義変数エラー

### Phase 2: ラベル・ジャンプ

- ラベル定義（`*label`）とラベルマップ構築
- `jump(label)` — 無条件ジャンプ
- `call(label)` / `ret()` — サブルーチン呼び出しと復帰
- `CallFrame` 型の定義
- コールスタック管理（`pushFrame` / `popFrame`）
- 未定義ラベルエラー
- 空スタックでの `ret()` エラー

### Phase 1: 基本構造

- `Interpreter` クラスの実装
- `Parser` クラスの実装（行分類）
- `GameState` クラスの実装
- `IEngineAPI` インターフェース定義
- 行種別の定義（`LineType` enum）
- セリフブロックの検出と表示
- 組み込みコマンドの実行（`bg`, `ch`, `ch_hide`, `ch_clear`, `ch_anim`, `bgm`, `bgm_stop`, `se`, `voice`, `wait`, `waitclick`, `timeline`, `timeline_play`, `battle`）
- コメントと空行のスキップ
- メインループ（`while (running && pc < lines.length)`）

## 既知の問題

| 問題 | 影響 | 回避策 |
|---|---|---|
| 深い再帰（fibonacci 等）でハング | Phase 5 の再帰テストが skip | 再帰深度上限（16）で保護。深い再帰が必要な場合は jump ループを使用 |
| `while` 構文の未実装 | ループ構文なし | ラベル + jump で代替 |
| `playTimeline()` の Web 実装なし | タイムラインコマンドが no-op | 将来の Web 実装で対応 |
| 行末コメント未対応 | `//` は行頭のみ | コメントは独立した行に記述 |

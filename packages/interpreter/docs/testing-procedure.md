# テスト手順書

> Generated by Claude Opus 4.6

## 1. テスト実行方法

### 1.1 全テスト実行

```bash
cd packages/interpreter
npm test
```

Vitest が `test/` ディレクトリ内の `*.test.ts` ファイルをすべて実行する。

### 1.2 個別テスト実行

```bash
# 特定のテストファイル
npx vitest run test/Parser.test.ts
npx vitest run test/Phase3.test.ts

# パターンマッチ
npx vitest run --reporter=verbose -t "変数"
```

### 1.3 ウォッチモード

```bash
npx vitest
```

ファイル変更を監視して自動再実行する。

## 2. テストケース一覧

### 2.1 Parser.test.ts

| # | テストケース | 検証内容 |
|---|---|---|
| 1 | 行分類: 空行 | `Empty` を返す |
| 2 | 行分類: コメント | `Comment` を返す |
| 3 | 行分類: ラベル | `Label` を返す |
| 4 | 行分類: セリフ開始 | `DialogueStart` を返す |
| 5 | 行分類: セリフ終了 | `DialogueEnd` を返す |
| 6 | 行分類: 式 | `Expression` を返す |
| 7 | ラベル名抽出 | `*start` → `"start"` |
| 8 | 話者名抽出 | `#hero` → `"hero"` |
| 9 | ラベルマップ構築 | 複数ラベルのマッピング |
| 10 | セリフ終了検索 | `#` の行番号を返す |
| 11 | ブロック終了検索 | `}` の行番号を返す |

### 2.2 Interpreter.test.ts

| # | テストケース | 検証内容 |
|---|---|---|
| 12 | 空スクリプト実行 | エラーなし |
| 13 | コメントのみ実行 | エラーなし |
| 14 | セリフ表示 | showDialogue が呼ばれる |
| 15 | 背景コマンド | setBg が呼ばれる |
| 16 | キャラ表示コマンド | showChar が呼ばれる |
| 17 | BGM コマンド | playBgm が呼ばれる |
| 18 | SE コマンド | playSe が呼ばれる |
| 19 | wait コマンド | wait が呼ばれる |

### 2.3 Phase2.test.ts — ラベルとジャンプ

| # | テストケース | 検証内容 |
|---|---|---|
| 20 | ラベルにジャンプ | jump で正しいラベルに移動 |
| 21 | 未定義ラベルエラー | jump で未定義ラベルにエラー |
| 22 | call/ret | call で移動し ret で復帰 |
| 23 | call スタック空 ret | エラーメッセージ |
| 24 | ネストされた call | 複数の call/ret |

### 2.4 Phase3.test.ts — 変数と式評価

| # | テストケース | 検証内容 |
|---|---|---|
| 25 | 数値代入 | `x = 10` → x が 10 |
| 26 | 文字列代入 | `name = "Player"` → name が "Player" |
| 27 | 真偽値代入 | `flag = true` → flag が true |
| 28 | 加算代入 | `x += 5` → 正しい値 |
| 29 | 減算代入 | `x -= 3` → 正しい値 |
| 30 | 乗算代入 | `x *= 2` → 正しい値 |
| 31 | 除算代入 | `x /= 4` → 正しい値 |
| 32 | 算術式 | `1 + 2 * 3` → 7 |
| 33 | 比較演算 | `x > 5` → true/false |
| 34 | 論理演算 | `a && b` → 正しい結果 |
| 35 | 文字列結合 | `"a" + "b"` → "ab" |
| 36 | 括弧のグループ化 | `(1 + 2) * 3` → 9 |
| 37 | 0 除算エラー | エラーメッセージ |
| 38 | 未定義変数エラー | エラーメッセージ |

### 2.5 Phase4.test.ts — 条件分岐と選択肢

| # | テストケース | 検証内容 |
|---|---|---|
| 39 | 単純な if (真) | ブロック実行 |
| 40 | 単純な if (偽) | ブロックスキップ |
| 41 | if/else | 正しいブランチ実行 |
| 42 | if/else if/else | 正しいブランチ実行 |
| 43 | ネストされた if | 内側の条件判定 |
| 44 | if ブロック内のコマンド | コマンド実行を確認 |
| 45 | choice 基本 | 選択肢表示と分岐 |
| 46 | choice 条件付き | 条件非表示 |
| 47 | choice 内の jump | ジャンプ動作 |

### 2.6 Phase5.test.ts — 関数とサブルーチン

| # | テストケース | 検証内容 |
|---|---|---|
| 48 | def 基本 | 戻り値が正しい |
| 49 | def 複数引数 | 引数の束縛 |
| 50 | sub 基本 | 副作用の実行 |
| 51 | sub 内で return expr | エラー |
| 52 | 引数数不一致 | エラー |
| 53 | 組み込み関数名の予約 | エラー |
| 54 | ローカルスコープ | グローバルと分離 |
| 55 | (skip) 再帰 | fibonacci 等 |

### 2.7 Phase6.test.ts — 文字列補間

| # | テストケース | 検証内容 |
|---|---|---|
| 56 | 変数の補間 | `{name}` → 値に置換 |
| 57 | 式の補間 | `{score + 10}` → 計算結果 |
| 58 | 補間エラー | 未定義変数で停止 |

### 2.8 ErrorHandling.test.ts

| # | テストケース | 検証内容 |
|---|---|---|
| 59 | Levenshtein 距離計算 | 正しい距離 |
| 60 | 類似変数提案 | 候補の正確さ |
| 61 | スタックトレースフォーマット | 正しい形式 |
| 62 | エラーメッセージフォーマット | 全構成要素 |
| 63 | コンテキスト生成 | 前後の行表示 |
| 64 | ReferenceError 生成 | 正しい構造 |
| 65 | StackOverflow 生成 | 正しい構造 |

### 2.9 Debug.test.ts

| # | テストケース | 検証内容 |
|---|---|---|
| 66 | 変数ウォッチ | 変更履歴の記録 |
| 67 | ブレークポイント | shouldBreak の判定 |
| 68 | 条件付きブレークポイント | 条件評価 |
| 69 | ステップ実行 | モード切り替え |
| 70 | トレースログ | ログの記録 |
| 71 | イベントリスナー | イベント発火 |

### 2.10 Integration.test.ts

| # | テストケース | 検証内容 |
|---|---|---|
| 72 | 全機能統合シナリオ | 変数・関数・選択肢・ジャンプの連携 |
| 73 | エラー時の処理 | 未定義変数で停止 |
| 74 | デバッグモード統合 | 変数追跡が動作 |
| 75 | 大量変数操作 | 100 変数を 500ms 以内 |
| 76 | (skip) 完全デモシナリオ | 外部ファイル実行 |
| 77 | (skip) 大規模ループ | 100 回ループ |
| 78 | (skip) 再帰 | fibonacci |

※ 上記は代表的なテストケース。実際のテスト数は 134 件以上。

## 3. 障害発生時の対処

### 3.1 テストが失敗した場合

1. エラーメッセージを確認
2. 該当するソースコードを調査
3. デバッグモードで変数状態を追跡
4. **テストをスキップするのではなく、コードを修正する**

### 3.2 タイムアウトの場合

- 無限ループの可能性を調査（jump のループ、再帰の終了条件）
- テストのタイムアウト設定を確認（Vitest のデフォルト: 5 秒）

## 4. 回帰テスト

コードを変更した際は必ず全テストを実行:

```bash
npm test
```

特に以下の変更は広範囲に影響する:
- Evaluator の式評価ロジック
- GameState のスコープ管理
- Parser の行分類
- Interpreter のメインループ

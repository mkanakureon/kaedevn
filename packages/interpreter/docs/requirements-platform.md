# プラットフォーム抽象化要求仕様書

> Generated by Claude Opus 4.6

## 1. 概要

本書は IEngineAPI に求められるプラットフォーム抽象化の要件を定義する。インタプリタはプラットフォーム固有の実装に依存せず、IEngineAPI を通じてのみ外部操作を行う。

## 2. 設計原則

1. **プラットフォーム非依存**: インタプリタコア（`src/core/`）はブラウザ API、Node.js API、Switch SDK を直接参照しない
2. **抽象化の境界**: 描画・音声・入力・ストレージはすべて IEngineAPI メソッドを通じてアクセス
3. **非同期制約**: ユーザー入力待ちやアニメーション完了待ちは `Promise` で表現
4. **同期メソッドの明示**: BGM/SE 再生開始のような fire-and-forget 操作は同期メソッド

## 3. メソッド一覧と各プラットフォームの期待動作

### 3.1 セリフ表示 — `showDialogue`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | PixiJS でメッセージウィンドウにテキストを描画、クリック/タップで次へ |
| **Console（テスト）** | `console.log` で出力、即座に resolve |
| **Switch** | Switch UI でメッセージ表示、ボタン入力待ち |

### 3.2 背景 — `setBg`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | PixiJS Sprite で背景画像を表示。effect 指定時はフェードトランジション |
| **Console** | ログ出力のみ |
| **Switch** | ネイティブレンダラーで背景描画 |

### 3.3 キャラクター — `showChar`, `hideChar`, `clearChars`, `moveChar`, `showCharAnim`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | PixiJS Sprite でキャラクター立ち絵を表示。position は画面上の left/center/right に対応。fadeMs でアルファアニメーション |
| **Console** | ログ出力のみ |
| **Switch** | ネイティブレンダラーで立ち絵描画 |

### 3.4 BGM — `playBgm`, `stopBgm`, `fadeBgm`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | Web Audio API でループ再生。vol は GainNode で制御 |
| **Console** | ログ出力のみ |
| **Switch** | ネイティブオーディオ API |

### 3.5 SE / Voice — `playSe`, `playVoice`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | Web Audio API でワンショット再生 |
| **Console** | ログ出力のみ |
| **Switch** | ネイティブオーディオ API |

### 3.6 タイムライン — `playTimeline`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | JSON タイムラインデータに基づくアニメーション実行（現在未実装） |
| **Console** | ログ出力のみ |
| **Switch** | ネイティブアニメーションシステム |

### 3.7 バトル — `battleStart`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | バトルシーンを表示し、結果（`'win'` / `'lose'`）を返す |
| **Console** | 常に `'win'` を返す |
| **Switch** | バトルシステムを起動 |

### 3.8 選択肢 — `showChoice`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | PixiJS でボタン UI を描画、クリック/タップで選択 |
| **Console** | 標準入力で番号を選択（またはデフォルト 0 を返す） |
| **Switch** | Switch UI で選択肢表示、D-pad + A ボタンで選択 |

### 3.9 待機 — `waitForClick`, `wait`

| プラットフォーム | 期待動作 |
|---|---|
| **Web** | `waitForClick`: PointerEvent 待ち。`wait`: `setTimeout` |
| **Console** | 即座に resolve |
| **Switch** | ボタン入力待ち / タイマー待ち |

## 4. 非同期制約

### 4.1 async メソッド（完了を待つ必要がある）

以下のメソッドは `Promise<void>` を返し、インタプリタは resolve されるまで次のコマンドを実行しない：

- `showDialogue` — クリック待ち
- `setBg` — エフェクト完了
- `showChar`, `hideChar`, `clearChars`, `moveChar`, `showCharAnim` — アニメーション完了
- `fadeBgm` — フェードアウト完了
- `playTimeline` — タイムライン完了
- `battleStart` — バトル終了
- `showChoice` — 選択完了
- `waitForClick` — クリック待ち
- `wait` — タイマー完了

### 4.2 sync メソッド（fire-and-forget）

以下のメソッドは即座に返る。再生開始のトリガーのみ：

- `playBgm` — BGM 再生開始
- `stopBgm` — BGM 停止
- `playSe` — SE 再生開始
- `playVoice` — ボイス再生開始

## 5. 拡張ポイント

### 5.1 新メソッドの追加

IEngineAPI に新メソッドを追加する場合：

1. `src/engine/IEngineAPI.ts` にメソッドシグネチャを追加
2. `src/core/Interpreter.ts` の `executeBuiltin()` に対応するコマンドを追加
3. 既存の全実装（Web, MockEngine 等）に実装を追加
4. 対応テストを追加

### 5.2 カスタムメソッド（将来計画）

ユーザーがゲーム固有のメソッドを追加できるプラグインシステムを計画中。詳細は [design-extensibility.md](design-extensibility.md) を参照。

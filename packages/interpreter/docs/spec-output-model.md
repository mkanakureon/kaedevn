# インタプリタ出力モデル仕様書

> Generated by Claude Opus 4.6

## 1. 概要

KSC インタプリタの出力は **IEngineAPI メソッドの呼び出し列**である。`.ksc` スクリプトを実行すると、インタプリタは IEngineAPI のメソッドを順番に呼び出す。最終的な出力形式（画面描画、テキスト、配列など）は IEngineAPI の実装が決定する。

```
.ksc スクリプト
    │
    ▼
  Interpreter
    │
    ▼ (メソッド呼び出し)
  IEngineAPI 実装
    │
    ├─→ Web (PixiJS)     → 画面描画・音声再生
    ├─→ Console           → console.log テキスト
    ├─→ Switch (SDL2)     → SDL2 描画・音声
    └─→ MockEngine        → ログ配列に記録
```

## 2. インタプリタの戻り値

```typescript
// run() は Promise<void> — 戻り値なし
await interpreter.run(script);

// getState() で内部状態のスナップショットを取得可能
const state = interpreter.getState();
// → { pc: number, variables: Record<string, unknown>, callStack: number }
```

- `run()` は副作用のみ（IEngineAPI 呼び出し）で値を返さない
- 実行結果は IEngineAPI 実装側に蓄積される
- 変数の最終状態は `getState()` で取得可能

## 3. プラットフォーム別の出力

### 3.1 Web（PixiJS）— 画面描画

出力は **Canvas への描画**と **Web Audio API の音声ストリーム**。IEngineAPI 呼び出しが PixiJS の描画コマンドに変換される。

```
スクリプト                IEngineAPI 呼び出し        Web 実装の処理
─────────────────────────────────────────────────────────────────────
bg("school")          → setBg("school")          → PIXI.Sprite をステージに追加
ch("hero", "smile")   → showChar("hero","smile") → キャラクター Sprite を追加
bgm("daily")          → playBgm("daily")         → Web Audio API で再生
#hero / text / #       → showDialogue("hero",[…]) → メッセージウィンドウ描画 + クリック待ち
choice { ... }         → showChoice([…])          → ボタン UI 描画 + 選択待ち
```

### 3.2 Console（テスト・デモ）— テキスト

出力は**プレーンテキスト（標準出力）**。IEngineAPI 呼び出しが `console.log` に変換される。

```
スクリプト                IEngineAPI 呼び出し        Console 実装の処理
─────────────────────────────────────────────────────────────────────
bg("school")          → setBg("school")          → console.log("[背景: school]")
ch("hero", "smile")   → showChar("hero","smile") → console.log("[キャラ: hero smile]")
bgm("daily")          → playBgm("daily")         → console.log("[BGM: daily]")
#hero / text / #       → showDialogue("hero",[…]) → console.log("【hero】\n  text")
choice { ... }         → showChoice([…])          → console.log("=== 選択肢 ===\n  1. ...")
                                                     → 自動で 0 を返す
```

### 3.3 MockEngine（テスト）— ログ配列

出力は **`string[]`（commandLog）と `{speaker, lines}[]`（dialogueLog）**。IEngineAPI 呼び出しが配列に記録され、テストの `expect` で検証に使用する。

```
スクリプト                IEngineAPI 呼び出し        MockEngine の処理
─────────────────────────────────────────────────────────────────────
bg("school")          → setBg("school")          → commandLog.push("bg:school")
ch("hero", "smile")   → showChar("hero","smile") → commandLog.push("ch:hero:smile")
bgm("daily")          → playBgm("daily")         → commandLog.push("bgm:daily")
#hero / text / #       → showDialogue("hero",[…]) → dialogueLog.push({speaker,lines})
choice { ... }         → showChoice([…])          → commandLog.push("choice:2opts")
                                                     → choiceResults[index] を返す
```

### 3.4 Switch（SDL2）— ネイティブ描画

出力は **SDL2 フレームバッファへの描画**。IEngineAPI 呼び出しが SDL2 API コールに変換される。

```
スクリプト                IEngineAPI 呼び出し        Switch 実装の処理
─────────────────────────────────────────────────────────────────────
bg("school")          → setBg("school")          → SDL_RenderCopy(texture)
ch("hero", "smile")   → showChar("hero","smile") → SDL_RenderCopy(charTexture)
bgm("daily")          → playBgm("daily")         → Mix_PlayMusic(music)
#hero / text / #       → showDialogue("hero",[…]) → TTF_RenderText + A ボタン待ち
choice { ... }         → showChoice([…])          → UI 描画 + D-pad/A 待ち
```

### 3.5 JSON ログ（計装用途）

出力は **JSON 配列**。IEngineAPI を実装して呼び出しを JSON として記録する。リプレイ、テスト自動化、デバッグに有用。

```typescript
class JsonLogEngine implements IEngineAPI {
  log: object[] = [];

  async showDialogue(speaker: string, lines: string[]) {
    this.log.push({
      type: "dialogue",
      speaker,
      lines,
      timestamp: Date.now(),
    });
  }

  async setBg(name: string, effect?: string) {
    this.log.push({
      type: "command",
      command: "bg",
      args: { name, effect },
      timestamp: Date.now(),
    });
  }

  // ... 他のメソッドも同様 ...

  toJSON(): string {
    return JSON.stringify(this.log, null, 2);
  }
}
```

出力例:

```json
[
  {
    "type": "command",
    "command": "bg",
    "args": { "name": "school", "effect": null },
    "timestamp": 1740000000000
  },
  {
    "type": "dialogue",
    "speaker": "hero",
    "lines": ["こんにちは！", "元気ですか？"],
    "timestamp": 1740000000001
  },
  {
    "type": "command",
    "command": "bgm",
    "args": { "name": "daily" },
    "timestamp": 1740000000002
  }
]
```

## 4. 出力の分類

| カテゴリ | 出力先 | 同期/非同期 | 例 |
|---|---|---|---|
| **セリフ** | showDialogue → 画面/コンソール | async（入力待ち） | テキスト表示 + クリック待ち |
| **描画** | setBg, showChar, hideChar 等 → 画面 | async（アニメ完了待ち） | 背景・立ち絵の表示 |
| **音声** | playBgm, playSe, playVoice → スピーカー | sync（fire-and-forget） | 再生開始のみ |
| **UI** | showChoice → 画面 | async（選択待ち） | 選択肢 UI → インデックス返却 |
| **待機** | wait, waitForClick → なし | async（タイマー/入力待ち） | 時間経過/クリック |
| **状態** | getState() → 呼び出し元 | sync | 変数スナップショット |

## 5. セーブデータとしての出力

スクリプト実行の結果は、セーブデータとして永続化できる:

```json
{
  "save_schema_version": 1,
  "engine_version": "0.1.0",
  "work_id": "my-game",
  "scenario_id": "chapter1",
  "node_id": "after_choice",
  "vars": {
    "affection": 5,
    "name": "太郎",
    "flag_library": true
  },
  "read": {},
  "timestamp": 1740000000000
}
```

- `vars` は `getState().variables` から取得
- セーブ/ロードは IEngineAPI の範囲外（IStorage 抽象層が担当）
- インタプリタ自体はセーブデータを生成しない（呼び出し側の責務）

## 6. デバッグ出力

デバッグモード有効時、Debugger が内部ログを蓄積する:

```typescript
const dbg = interpreter.getDebugger();

// 変数変更履歴
dbg.getVariableHistory("score");
// → [{ line: 5, oldValue: 0, newValue: 10, timestamp: ... }, ...]

// トレースログ
dbg.getTraceLog();
// → ["[2026-...] [Line 5] score changed: 0 → 10",
//    "[2026-...] [Line 8] call mood(10)",
//    "[2026-...] [Line 8] mood() returned \"happy\""]
```

デバッグ出力は IEngineAPI の出力とは別系統で、開発者向けの内部情報。

## 7. まとめ

インタプリタの出力は **IEngineAPI メソッドの呼び出し列**である。最終的な出力形式は IEngineAPI 実装が決定する。

```
                         ┌─────────────────────────────┐
  .ksc スクリプト ──────→ │       Interpreter            │
                         │                             │
                         │  出力 = IEngineAPI 呼び出し列 │
                         └──────────┬──────────────────┘
                                    │
                    IEngineAPI メソッド呼び出し列
                                    │
              ┌─────────┬───────────┼───────────┬──────────┐
              ▼         ▼           ▼           ▼          ▼
           Web       Console     Switch     MockEngine  JsonLog
         (Canvas)  (stdout)   (SDL2 描画)  (配列記録)  (JSON 記録)
```

| IEngineAPI 実装 | 出力形式 |
|---|---|
| Web (PixiJS) | Canvas 描画 + Web Audio 音声 |
| Console | プレーンテキスト（標準出力） |
| Switch (SDL2) | SDL2 フレームバッファ描画 |
| MockEngine | `string[]` + `{speaker, lines}[]` 配列 |
| JsonLogEngine | JSON 配列 |

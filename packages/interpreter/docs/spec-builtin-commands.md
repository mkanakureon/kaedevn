# 組み込みコマンド仕様書

> Generated by Claude Opus 4.6

## 1. 概要

インタプリタには 17 個の組み込みコマンドが定義されている。各コマンドは `Interpreter.executeBuiltin()` で処理され、対応する `IEngineAPI` メソッドを呼び出す。

## 2. コマンドリファレンス

### 2.1 bg — 背景設定

```ksc
bg("school_day")
bg("room", "fade")
```

| 項目 | 内容 |
|---|---|
| 構文 | `bg(name)` / `bg(name, effect)` |
| 引数 | `name: string` — 背景 ID<br>`effect?: string` — エフェクト名 |
| 非同期 | Yes |
| IEngineAPI | `setBg(name, effect)` |

### 2.2 ch — キャラクター表示

```ksc
ch("hero", "smile", "center")
ch("heroine", "angry", "left", 500)
```

| 項目 | 内容 |
|---|---|
| 構文 | `ch(name, pose)` / `ch(name, pose, position)` / `ch(name, pose, position, fadeMs)` |
| 引数 | `name: string` — キャラクター名<br>`pose: string` — ポーズ名<br>`position?: string` — 位置<br>`fadeMs?: number` — フェード時間 |
| 非同期 | Yes |
| IEngineAPI | `showChar(name, pose, position, fadeMs)` |

### 2.3 ch_anim — キャラクターアニメーション表示

```ksc
ch_anim("hero", "attack", "center")
```

| 項目 | 内容 |
|---|---|
| 構文 | `ch_anim(name, pose, position)` |
| 引数 | `name: string` — キャラクター名<br>`pose: string` — アニメーションスラッグ<br>`position: string` — 位置 |
| 非同期 | Yes |
| IEngineAPI | `showCharAnim(name, pose, position)` |

### 2.4 ch_hide — キャラクター非表示

```ksc
ch_hide("hero")
ch_hide("hero", 500)
```

| 項目 | 内容 |
|---|---|
| 構文 | `ch_hide(name)` / `ch_hide(name, fadeMs)` |
| 引数 | `name: string` — キャラクター名<br>`fadeMs?: number` — フェード時間 |
| 非同期 | Yes |
| IEngineAPI | `hideChar(name, fadeMs)` |

### 2.5 ch_clear — 全キャラクター消去

```ksc
ch_clear()
ch_clear(300)
```

| 項目 | 内容 |
|---|---|
| 構文 | `ch_clear()` / `ch_clear(fadeMs)` |
| 引数 | `fadeMs?: number` — フェード時間 |
| 非同期 | Yes |
| IEngineAPI | `clearChars(fadeMs)` |

### 2.6 bgm — BGM 再生

```ksc
bgm("title_theme")
bgm("battle", 80, 1000)
```

| 項目 | 内容 |
|---|---|
| 構文 | `bgm(name)` / `bgm(name, vol)` / `bgm(name, vol, fadeMs)` |
| 引数 | `name: string` — BGM ID<br>`vol?: number` — 音量 (0–100)<br>`fadeMs?: number` — フェードイン時間 |
| 非同期 | **No（sync）** |
| IEngineAPI | `playBgm(name, vol, fadeMs)` |

### 2.7 bgm_stop — BGM 停止

```ksc
bgm_stop()
bgm_stop(1000)
```

| 項目 | 内容 |
|---|---|
| 構文 | `bgm_stop()` / `bgm_stop(fadeMs)` |
| 引数 | `fadeMs?: number` — フェード時間。0 または未指定で即停止 |
| 非同期 | fadeMs > 0 の場合 Yes、それ以外は No |
| IEngineAPI | fadeMs > 0: `fadeBgm(fadeMs)`<br>それ以外: `stopBgm()` |

### 2.8 se — 効果音再生

```ksc
se("click")
se("explosion", 100)
```

| 項目 | 内容 |
|---|---|
| 構文 | `se(name)` / `se(name, vol)` |
| 引数 | `name: string` — SE ID<br>`vol?: number` — 音量 (0–100) |
| 非同期 | **No（sync）** |
| IEngineAPI | `playSe(name, vol)` |

### 2.9 voice — ボイス再生

```ksc
voice("hero_001")
```

| 項目 | 内容 |
|---|---|
| 構文 | `voice(name)` |
| 引数 | `name: string` — ボイスファイル ID |
| 非同期 | **No（sync）** |
| IEngineAPI | `playVoice(name)` |

### 2.10 wait — 時間待機

```ksc
wait(500)
wait(2000)
```

| 項目 | 内容 |
|---|---|
| 構文 | `wait(ms)` |
| 引数 | `ms: number` — 待機時間（ミリ秒） |
| 非同期 | Yes |
| IEngineAPI | `wait(ms)` |

### 2.11 waitclick — クリック待機

```ksc
waitclick()
```

| 項目 | 内容 |
|---|---|
| 構文 | `waitclick()` |
| 非同期 | Yes |
| IEngineAPI | `waitForClick()` |

### 2.12 jump — ラベルジャンプ

```ksc
jump("chapter2")
```

| 項目 | 内容 |
|---|---|
| 構文 | `jump(label)` |
| 引数 | `label: string` — ジャンプ先ラベル名 |
| 非同期 | No |
| PC 制御 | Yes — PC をラベルの次の行に設定 |
| エラー | 未定義ラベルで `[KNF Error] 未定義のラベル: {label}` |

### 2.13 call — サブルーチン呼び出し

```ksc
call("common_event")
```

| 項目 | 内容 |
|---|---|
| 構文 | `call(label)` |
| 引数 | `label: string` — 呼び出し先ラベル名 |
| 非同期 | No |
| PC 制御 | Yes — 現在の PC+1 をコールスタックに push し、ラベルの次の行にジャンプ |
| エラー | 未定義ラベルで `[KNF Error] 未定義のラベル: {label}` |

### 2.14 ret — サブルーチン復帰

```ksc
ret()
```

| 項目 | 内容 |
|---|---|
| 構文 | `ret()` |
| 非同期 | No |
| PC 制御 | Yes — コールスタックから pop して復帰先に戻る |
| エラー | スタック空: `ret()が呼ばれましたが、呼び出しスタックが空です`<br>非 label フレーム: `ret()は call(label) の復帰専用です` |

### 2.15 timeline / timeline_play — タイムライン実行

```ksc
timeline("opening_anim")
timeline_play("cutscene1")
```

| 項目 | 内容 |
|---|---|
| 構文 | `timeline(name)` / `timeline_play(name)` |
| 引数 | `name: string` — タイムライン名 |
| 非同期 | Yes |
| IEngineAPI | `playTimeline(name)` |
| 備考 | `timeline` と `timeline_play` は同一の処理 |

### 2.16 battle — バトル開始

```ksc
battle("goblin_squad")
battle("goblin_squad", "win_label", "lose_label")
```

| 項目 | 内容 |
|---|---|
| 構文 | `battle(troopId)` / `battle(troopId, onWin, onLose)` |
| 引数 | `troopId: string` — 敵グループ ID<br>`onWin?: string` — 勝利時のジャンプ先ラベル<br>`onLose?: string` — 敗北時のジャンプ先ラベル |
| 非同期 | Yes |
| PC 制御 | ジャンプ先ラベルが指定され、結果に一致する場合は Yes |
| IEngineAPI | `battleStart(troopId)` → `'win'` / `'lose'` |

## 3. コマンド一覧表

| コマンド | 非同期 | PC 制御 | IEngineAPI メソッド |
|---|---|---|---|
| `bg` | Yes | No | `setBg` |
| `ch` | Yes | No | `showChar` |
| `ch_anim` | Yes | No | `showCharAnim` |
| `ch_hide` | Yes | No | `hideChar` |
| `ch_clear` | Yes | No | `clearChars` |
| `bgm` | No | No | `playBgm` |
| `bgm_stop` | 条件付き | No | `stopBgm` / `fadeBgm` |
| `se` | No | No | `playSe` |
| `voice` | No | No | `playVoice` |
| `wait` | Yes | No | `wait` |
| `waitclick` | Yes | No | `waitForClick` |
| `jump` | No | **Yes** | ― |
| `call` | No | **Yes** | ― |
| `ret` | No | **Yes** | ― |
| `timeline` | Yes | No | `playTimeline` |
| `timeline_play` | Yes | No | `playTimeline` |
| `battle` | Yes | 条件付き | `battleStart` |

## 4. エラー時の挙動

- 未実装コマンド名は `console.warn` で警告し、スキップする
- 組み込み関数名は式の中で呼び出せない（`組み込み関数 'X' は式の中では使用できません`）
- 組み込み関数は値を返さない（`組み込み関数 'X' は値を返しません`）

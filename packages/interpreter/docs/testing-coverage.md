# テストカバレッジ報告書

> Generated by Claude Opus 4.6

## 1. 概況

| 指標 | 値 |
|---|---|
| テストファイル数 | 12 |
| テストケース数 | 134+ |
| skip されたテスト | 約 6 件 |
| テストフレームワーク | Vitest |

## 2. フェーズ別カバレッジ

### 2.1 Phase 1 — Parser・基本構造

| 機能 | カバー | テストファイル |
|---|---|---|
| 行分類（全 6 種別） | 完全 | Parser.test.ts |
| ラベルマップ構築 | 完全 | Parser.test.ts |
| セリフブロック検出 | 完全 | Parser.test.ts, Interpreter.test.ts |
| ブロック終了検索 | 完全 | Parser.test.ts |
| 関数定義パース | 完全 | Phase5.test.ts |
| choice パース | 完全 | Phase4.test.ts |

### 2.2 Phase 2 — ラベル・ジャンプ

| 機能 | カバー | テストファイル |
|---|---|---|
| jump | 完全 | Phase2.test.ts |
| call/ret | 完全 | Phase2.test.ts |
| 未定義ラベルエラー | 完全 | Phase2.test.ts |
| 空スタック ret エラー | 完全 | Phase2.test.ts |
| ネストされた call | 完全 | Phase2.test.ts |

### 2.3 Phase 3 — 変数・式評価

| 機能 | カバー | テストファイル |
|---|---|---|
| 数値/文字列/真偽値リテラル | 完全 | Phase3.test.ts |
| 代入演算子（=, +=, -=, *=, /=） | 完全 | Phase3.test.ts |
| 算術演算（+, -, *, /, %） | 完全 | Phase3.test.ts |
| 比較演算（==, !=, >, >=, <, <=） | 完全 | Phase3.test.ts |
| 論理演算（&&, \|\|, !） | 完全 | Phase3.test.ts |
| 文字列結合 | 完全 | Phase3.test.ts |
| 括弧のグループ化 | 完全 | Phase3.test.ts |
| 0 除算エラー | 完全 | Phase3.test.ts |
| 未定義変数エラー | 完全 | Phase3.test.ts |

### 2.4 Phase 4 — 条件分岐・選択肢

| 機能 | カバー | テストファイル |
|---|---|---|
| if (真/偽) | 完全 | Phase4.test.ts |
| if/else | 完全 | Phase4.test.ts |
| if/else if/else | 完全 | Phase4.test.ts |
| ネストされた if | 完全 | Phase4.test.ts |
| choice 基本 | 完全 | Phase4.test.ts |
| choice 条件付き | 完全 | Phase4.test.ts |
| choice 内 jump | 完全 | Phase4.test.ts |

### 2.5 Phase 5 — 関数・サブルーチン

| 機能 | カバー | テストファイル |
|---|---|---|
| def 基本（戻り値） | 完全 | Phase5.test.ts |
| sub 基本（副作用） | 完全 | Phase5.test.ts |
| 引数束縛 | 完全 | Phase5.test.ts |
| ローカルスコープ | 完全 | Phase5.test.ts |
| sub 内 return expr エラー | 完全 | Phase5.test.ts |
| 引数数不一致エラー | 完全 | Phase5.test.ts |
| 組み込み関数名予約エラー | 完全 | Phase5.test.ts |
| **再帰呼び出し** | **未カバー（skip）** | Phase5.test.ts |
| **再帰深度上限** | **部分的** | Phase5.test.ts |

### 2.6 Phase 6 — 文字列補間

| 機能 | カバー | テストファイル |
|---|---|---|
| 変数の補間 | 完全 | Phase6.test.ts |
| 式の補間 | 完全 | Phase6.test.ts |
| 補間エラー | 完全 | Phase6.test.ts |

### 2.7 Phase 7-1 — エラーハンドリング

| 機能 | カバー | テストファイル |
|---|---|---|
| Levenshtein 距離 | 完全 | ErrorHandling.test.ts |
| 類似変数提案 | 完全 | ErrorHandling.test.ts |
| スタックトレース | 完全 | ErrorHandling.test.ts |
| エラーフォーマット | 完全 | ErrorHandling.test.ts |
| コンテキスト生成 | 完全 | ErrorHandling.test.ts |
| 各種ファクトリメソッド | 完全 | ErrorHandling.test.ts |

### 2.8 Phase 7-2 — デバッグ

| 機能 | カバー | テストファイル |
|---|---|---|
| 変数ウォッチ | 完全 | Debug.test.ts |
| ブレークポイント | 完全 | Debug.test.ts |
| 条件付きブレークポイント | 完全 | Debug.test.ts |
| ステップ実行制御 | 完全 | Debug.test.ts |
| トレースログ | 完全 | Debug.test.ts |
| イベントリスナー | 完全 | Debug.test.ts |

### 2.9 Phase 7-3 — 統合テスト

| 機能 | カバー | テストファイル |
|---|---|---|
| 全機能統合シナリオ | 完全 | Integration.test.ts |
| エラー時の処理 | 完全 | Integration.test.ts |
| デバッグモード統合 | 完全 | Integration.test.ts |
| 大量変数操作 | 完全 | Integration.test.ts |
| **完全デモシナリオ** | **未カバー（skip）** | Integration.test.ts |
| **大規模ループ** | **未カバー（skip）** | Integration.test.ts |
| **再帰統合** | **未カバー（skip）** | Integration.test.ts |

## 3. 未カバー領域

### 3.1 Phase 5 再帰

**状態**: 既知の問題（ハング）

**詳細**: fibonacci 等の再帰関数テストが無限ループに陥る。原因は `executeUserFunction` 内の PC 管理と再帰呼び出しの相互作用。

**リスク**: 中。単純な再帰（1 段）は動作するが、深い再帰やツリー再帰でハングする可能性がある。

**対応計画**: PC 保存/復元のロジックを改善し、再帰テストを有効化する。

### 3.2 大規模シナリオ

**状態**: テストが skip

**詳細**: 100 行以上のスクリプトや 100 回ループのテストがタイムアウトまたは skip。

**リスク**: 低。個々の機能はテスト済みで、パフォーマンステスト（100 変数操作）は通過している。

### 3.3 外部ファイルのデモシナリオ

**状態**: テストが skip

**詳細**: `examples/04-full-scenario.ksc` を使用するテストが skip。ファイルの存在に依存する。

**リスク**: 低。統合テストでインラインスクリプトによる同等のテストが通過している。

## 4. カバレッジ向上計画

| 項目 | 優先度 | 対応 |
|---|---|---|
| Phase 5 再帰の修正 | 高 | PC 管理ロジックの改善 |
| 大規模シナリオテスト | 中 | インラインスクリプトで段階的にテスト |
| タイムラインコマンド | 低 | Web 実装完了後 |
| battle コマンド | 低 | バトルシステム実装後 |
| `while` ループ | 低 | 構文実装後 |

## 5. リスク分析

| リスク | 影響度 | 発生確率 | 対策 |
|---|---|---|---|
| 再帰バグがユーザーに影響 | 中 | 中 | 再帰深度上限（16）で保護 |
| 大規模スクリプトでハング | 高 | 低 | ループ回数制限を検討 |
| エッジケースの未検出 | 中 | 中 | Fuzzing テストの導入を検討 |
| プラットフォーム互換性 | 低 | 低 | 外部依存ゼロで軽減 |

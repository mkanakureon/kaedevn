# ConsoleEngine ガイド

> Generated by Claude Opus 4.6

## 1. ConsoleEngine とは

`ConsoleEngine` は IEngineAPI の公式コンソール実装である。.ksc スクリプトの全コマンドを標準出力のテキストに変換する。

用途:

- スクリプトの動作確認・デバッグ
- テストでの出力キャプチャ・検証
- 自作 IEngineAPI 実装のリファレンス
- CI/CD パイプラインでのスクリプト検証

## 2. 基本的な使い方

```typescript
import { Interpreter, ConsoleEngine } from "@kaedevn/interpreter";

const engine = new ConsoleEngine();
const interpreter = new Interpreter(engine);

await interpreter.run(`
bg("school")
bgm("daily")

#hero
こんにちは
良い天気ですね
#
`);
```

出力:

```
[背景] school
[BGM] daily

【hero】
  こんにちは
  良い天気ですね
```

## 3. 動作原理

インタプリタの出力は IEngineAPI メソッドの呼び出し列である（[spec-output-model.md](spec-output-model.md) 参照）。ConsoleEngine は各メソッド呼び出しをテキストに変換して `output` 関数に渡す。

```
.ksc スクリプト → Interpreter → IEngineAPI メソッド呼び出し → ConsoleEngine → テキスト出力
```

各メソッドの変換ルール:

| メソッド | 出力フォーマット |
|---|---|
| `showDialogue("hero", ["text"])` | `【hero】\n  text` |
| `showDialogue("", ["text"])` | `【ナレーション】\n  text` |
| `setBg("school")` | `[背景] school` |
| `setBg("room", "fade")` | `[背景] room (fade)` |
| `showChar("hero", "smile", "center")` | `[キャラ表示] hero smile center` |
| `showCharAnim("hero", "idle", "center")` | `[キャラアニメ] hero idle center` |
| `hideChar("hero")` | `[キャラ非表示] hero` |
| `clearChars()` | `[キャラ全消去]` |
| `moveChar("hero", "right", 800)` | `[キャラ移動] hero → right (800ms)` |
| `playBgm("daily")` | `[BGM] daily` |
| `playBgm("battle", 80, 1000)` | `[BGM] battle vol=80 fade=1000ms` |
| `stopBgm()` | `[BGM停止]` |
| `fadeBgm(2000)` | `[BGMフェード] 2000ms` |
| `playSe("click")` | `[SE] click` |
| `playSe("explosion", 90)` | `[SE] explosion vol=90` |
| `playVoice("hero_001")` | `[ボイス] hero_001` |
| `playTimeline("opening")` | `[タイムライン] opening` |
| `battleStart("troop_001")` | `[バトル] troop_001 → win` |
| `showChoice([...])` | `=== 選択肢 ===\n  1. ...\n→ 自動選択: 1` |
| `waitForClick()` | `[クリック待ち]` |
| `wait(1000)` | `[待機] 1000ms` |

オプション引数は指定時のみ表示される。

## 4. ConsoleEngineOptions

```typescript
import { ConsoleEngine } from "@kaedevn/interpreter";
import type { ConsoleEngineOptions } from "@kaedevn/interpreter";

const options: ConsoleEngineOptions = {
  defaultChoice: 0,
  defaultBattleResult: "win",
  realTime: false,
  output: console.log,
};

const engine = new ConsoleEngine(options);
```

| オプション | 型 | デフォルト | 説明 |
|---|---|---|---|
| `defaultChoice` | `number` | `0` | `showChoice()` が返すインデックス |
| `defaultBattleResult` | `"win" \| "lose"` | `"win"` | `battleStart()` が返す結果 |
| `realTime` | `boolean` | `false` | `true` で `wait()` が実際に待機する |
| `output` | `(message: string) => void` | `console.log` | テキストの出力先 |

## 5. 拡張パターン

### 5.1 出力先の変更

`output` オプションで出力先を差し替える。

**ファイル出力:**

```typescript
import * as fs from "fs";

const stream = fs.createWriteStream("output.log");
const engine = new ConsoleEngine({
  output: (msg) => stream.write(msg + "\n"),
});
```

**配列キャプチャ（テスト用）:**

```typescript
const logs: string[] = [];
const engine = new ConsoleEngine({
  output: (msg) => logs.push(msg),
});

await interpreter.run(script);

// logs を検証
expect(logs[0]).toBe("[背景] school");
```

**WebSocket 転送:**

```typescript
const engine = new ConsoleEngine({
  output: (msg) => ws.send(JSON.stringify({ type: "engine", text: msg })),
});
```

### 5.2 サブクラスによるメソッド上書き

特定のメソッドだけ挙動を変えたい場合、ConsoleEngine を継承する。

```typescript
import { ConsoleEngine } from "@kaedevn/interpreter";
import type { ChoiceOption } from "@kaedevn/interpreter";
import * as readline from "readline";

class InteractiveEngine extends ConsoleEngine {
  // 選択肢をユーザーに入力させる
  async showChoice(options: ChoiceOption[]): Promise<number> {
    console.log("\n=== 選択肢 ===");
    options.forEach((opt, i) => console.log(`  ${i + 1}. ${opt.text}`));

    const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
    const answer = await new Promise<string>((resolve) => {
      rl.question("番号を入力: ", resolve);
    });
    rl.close();

    return parseInt(answer, 10) - 1;
  }

  // wait を実時間で待機
  async wait(ms: number): Promise<void> {
    console.log(`[待機] ${ms}ms`);
    await new Promise((resolve) => setTimeout(resolve, ms));
  }
}
```

### 5.3 IEngineAPI をゼロから実装する

ConsoleEngine をリファレンスとして、独自の IEngineAPI を実装できる。

```typescript
import type { IEngineAPI, ChoiceOption } from "@kaedevn/interpreter";

class MyEngine implements IEngineAPI {
  // 全 17 メソッドを実装する
  // ConsoleEngine のソースコードを参考に
  // async/sync の区別に注意（spec-engine-api.md 参照）
}
```

実装時のポイント:

- `showDialogue`, `showChoice` — async。ユーザー入力を待つ
- `playBgm`, `stopBgm`, `playSe`, `playVoice` — sync（void を返す）。再生開始のみ
- その他 — async。アニメーション完了を待つ
- `battleStart` — async。`"win" | "lose"` を返す
- `showChoice` — async。0 始まりのインデックスを返す

詳細は [spec-engine-api.md](spec-engine-api.md)、実装例は [guide-engine-implementation.md](guide-engine-implementation.md) を参照。

### 5.4 ログ記録の追加

ConsoleEngine を継承して、呼び出し履歴を記録する。

```typescript
interface EngineLog {
  method: string;
  args: unknown[];
  timestamp: number;
}

class LoggingEngine extends ConsoleEngine {
  logs: EngineLog[] = [];

  private record(method: string, args: unknown[]) {
    this.logs.push({ method, args, timestamp: Date.now() });
  }

  async showDialogue(speaker: string, lines: string[]) {
    this.record("showDialogue", [speaker, lines]);
    await super.showDialogue(speaker, lines);
  }

  async setBg(name: string, effect?: string) {
    this.record("setBg", [name, effect]);
    await super.setBg(name, effect);
  }

  // 他のメソッドも同様に override ...

  toJSON(): string {
    return JSON.stringify(this.logs, null, 2);
  }
}
```

## 6. テストでの活用

### 6.1 基本パターン

```typescript
import { describe, it, expect } from "vitest";
import { Interpreter, ConsoleEngine } from "@kaedevn/interpreter";

describe("my script", () => {
  it("背景とセリフを出力する", async () => {
    const logs: string[] = [];
    const engine = new ConsoleEngine({ output: (msg) => logs.push(msg) });
    const interpreter = new Interpreter(engine);

    await interpreter.run(`
bg("school")
#hero
こんにちは
#
`);

    expect(logs).toEqual([
      "[背景] school",
      "\n【hero】\n  こんにちは",
    ]);
  });
});
```

### 6.2 選択肢の分岐テスト

`defaultChoice` を変えてシナリオ分岐を検証する。

```typescript
it("2番目の選択肢でスコアが5増える", async () => {
  const logs: string[] = [];
  const engine = new ConsoleEngine({
    output: (msg) => logs.push(msg),
    defaultChoice: 1,  // 2番目を選択
  });
  const interpreter = new Interpreter(engine);

  await interpreter.run(`
score = 0
choice {
  "勉強する" { score += 10 }
  "遊ぶ" { score += 5 }
}
`);

  expect(interpreter.getState().variables.score).toBe(5);
});
```

### 6.3 バトル結果の分岐テスト

```typescript
it("敗北時にゲームオーバーラベルへ飛ぶ", async () => {
  const logs: string[] = [];
  const engine = new ConsoleEngine({
    output: (msg) => logs.push(msg),
    defaultBattleResult: "lose",
  });
  const interpreter = new Interpreter(engine);

  await interpreter.run(`
battle("boss", "win_route", "gameover")
jump("end")

*win_route
result = "victory"
jump("end")

*gameover
result = "defeat"

*end
`);

  expect(interpreter.getState().variables.result).toBe("defeat");
});
```

## 7. 関連ドキュメント

| やりたいこと | 参照先 |
|---|---|
| IEngineAPI の全メソッド仕様 | [spec-engine-api.md](spec-engine-api.md) |
| プラットフォーム別の出力形式 | [spec-output-model.md](spec-output-model.md) |
| Web/MockEngine の実装例 | [guide-engine-implementation.md](guide-engine-implementation.md) |
| IEngineAPI にメソッドを追加する | [design-extensibility.md](design-extensibility.md) |
| スクリプトの書き方 | [guide-scripting.md](guide-scripting.md) |
| API リファレンス | [api-reference.md](api-reference.md) |

# KSC 言語仕様書

> Generated by Claude Opus 4.6

## 1. 概要

KSC（Kaede Script）は kaedevn ビジュアルノベルエンジン用のスクリプト言語である。テキストベースで 1 行 1 命令の原則に従い、コンパイルなしにインタプリタが直接実行する。

## 2. 文法定義

### 2.1 EBNF

```ebnf
script        = { line } ;
line          = dialogue_start | dialogue_end | label
              | comment | empty | expression ;

(* セリフ *)
dialogue_start = "#" identifier ;
dialogue_end   = "#" ;
dialogue_block = dialogue_start { text_line } dialogue_end ;
text_line      = { character | interpolation } ;
interpolation  = "{" expression "}" ;

(* ラベル *)
label          = "*" identifier ;

(* コメント *)
comment        = "//" { character } ;

(* 空行 *)
empty          = "" ;

(* 式 / 文 *)
expression     = assignment | if_stmt | choice_stmt
               | func_def | sub_def | return_stmt
               | func_call | expr ;

(* 代入 *)
assignment     = identifier assign_op expr ;
assign_op      = "=" | "+=" | "-=" | "*=" | "/=" ;

(* if 文 *)
if_stmt        = "if" "(" expr ")" block
                 { "} else if" "(" expr ")" block }
                 [ "} else" block ] ;
block          = "{" { line } "}" ;

(* 選択肢 *)
choice_stmt    = "choice" "{" { choice_option } "}" ;
choice_option  = '"' text '"' [ "if" "(" expr ")" ] block ;

(* 関数定義 *)
func_def       = "def" identifier "(" [ param_list ] ")" block ;
sub_def        = "sub" identifier "(" [ param_list ] ")" block ;
param_list     = identifier { "," identifier } ;

(* return 文 *)
return_stmt    = "return" [ expr ] ;

(* 関数呼び出し *)
func_call      = identifier "(" [ arg_list ] ")" ;
arg_list       = expr { "," expr } ;

(* 式 — 優先順位は §4 参照 *)
expr           = logic_or ;
logic_or       = logic_and { "||" logic_and } ;
logic_and      = equality { "&&" equality } ;
equality       = comparison { ( "==" | "!=" ) comparison } ;
comparison     = addition { ( ">" | ">=" | "<" | "<=" ) addition } ;
addition       = multiplication { ( "+" | "-" ) multiplication } ;
multiplication = unary { ( "*" | "/" | "%" ) unary } ;
unary          = ( "!" | "-" ) unary | primary ;
primary        = number | string | boolean | identifier
               | identifier "(" [ arg_list ] ")"
               | "(" expr ")" ;

(* リテラル *)
number         = digit { digit } [ "." digit { digit } ] ;
string         = '"' { string_char } '"'
               | "'" { string_char } "'" ;
boolean        = "true" | "false" ;
identifier     = letter { letter | digit | "_" } ;

letter         = "a"..."z" | "A"..."Z" | "_" ;
digit          = "0"..."9" ;
```

## 3. 構文要素

### 3.1 セリフブロック

話者名を `#` の後に記述し、`#` 単体で終了する。

```ksc
#hero
こんにちは！
これはビジュアルノベルエンジンです。
#
```

- 話者名が空文字列の場合（`#` の後にスペースのみ）は地の文として扱われる
- セリフブロック内では文字列補間 `{式}` が有効

### 3.2 ラベル

`*` で始まる行はラベル定義。`jump()` や `call()` のターゲットになる。

```ksc
*chapter1
*ending_good
```

- ラベル名は英数字とアンダースコアで構成
- 日本語のラベル名も使用可能（`*オープニング`）
- 同名ラベルの重複定義は後勝ち

### 3.3 変数

```ksc
affection = 0
name = "Player"
flag = true
empty = false
```

### 3.4 条件分岐

```ksc
if (affection >= 5) {
  // 高好感度ルート
} else if (affection >= 3) {
  // 中好感度ルート
} else {
  // 低好感度ルート
}
```

- `} else if` と `} else {` は閉じブレースと同じ行に記述する
- ネストされた if 文をサポート

### 3.5 選択肢

```ksc
choice {
  "一緒に帰る" {
    affection += 2
    jump("go_home")
  }
  "図書館に行く" if (affection >= 3) {
    jump("library")
  }
}
```

- 各選択肢には任意で `if (条件)` を付与可能
- 条件が false の選択肢は非表示になる
- 表示可能な選択肢が 0 件の場合はランタイムエラー

### 3.6 関数定義（def）

値を返す関数。

```ksc
def mood(aff) {
  if (aff >= 8) {
    return "happy"
  }
  return "normal"
}

result = mood(10)
```

- `return expr` で値を返す
- `return` 単体は `undefined` を返す
- 組み込み関数名と同名の関数定義はエラー

### 3.7 サブルーチン定義（sub）

副作用専用。値を返せない。

```ksc
sub greet() {
  #hero
  こんにちは！
  #
}

greet()
```

- `return` 単体は許可（値なし終了）
- `return expr` はエラー

### 3.8 ラベルベースのサブルーチン（call/ret）

```ksc
call("common_event")
// ... call 先から ret() で戻ってくる

*common_event
bg("school")
#narrator
共通イベント
#
ret()
```

- `call()` は現在の PC をスタックに保存してジャンプ
- `ret()` はスタックから復帰（`call` で呼ばれた場合のみ使用可能）

### 3.9 コメント

```ksc
// これはコメントです
x = 10 // 行末コメントは不可（行全体がコメントか式かの二者択一）
```

- `//` で始まる行はコメント
- 行の途中からのコメントは未サポート

## 4. 演算子優先順位

上から優先度が低い順：

| 優先度 | 演算子 | 結合性 | 説明 |
|---|---|---|---|
| 1（最低） | `\|\|` | 左 | 論理 OR |
| 2 | `&&` | 左 | 論理 AND |
| 3 | `==` `!=` | 左 | 等価比較 |
| 4 | `>` `>=` `<` `<=` | 左 | 大小比較 |
| 5 | `+` `-` | 左 | 加算・減算・文字列結合 |
| 6 | `*` `/` `%` | 左 | 乗算・除算・剰余 |
| 7（最高） | `!` `-`（単項） | 右 | 論理否定・符号反転 |

## 5. 型システム

### 5.1 サポートする型

| 型 | リテラル例 | 説明 |
|---|---|---|
| `number` | `42`, `3.14`, `-1` | 浮動小数点数（JavaScript の `number`） |
| `string` | `"hello"`, `'world'` | 文字列。ダブルクォート・シングルクォート両対応 |
| `boolean` | `true`, `false` | 真偽値 |
| `null` | ― | 未定義変数参照時にエラーとなる（暗黙の null は不可） |

### 5.2 型強制ルール

| 演算 | ルール |
|---|---|
| `number + number` | 加算 |
| `string + any` / `any + string` | 文字列結合（`String()` で変換） |
| `number - number` | 減算 |
| 比較演算 | 両辺を `number` として比較 |
| 論理演算 | truthy/falsy 判定（後述） |
| `!value` | `boolean` に変換して否定 |

### 5.3 Truthy / Falsy

| 値 | 判定 |
|---|---|
| `true` | truthy |
| `false` | falsy |
| `0` | falsy |
| 非ゼロの `number` | truthy |
| `""` （空文字列） | falsy |
| 非空の `string` | truthy |
| `null` / `undefined` | falsy |

## 6. エスケープシーケンス

文字列リテラル内で使用可能：

| シーケンス | 意味 |
|---|---|
| `\n` | 改行 |
| `\t` | タブ |
| `\\` | バックスラッシュ |
| `\"` | ダブルクォート |
| `\'` | シングルクォート |

## 7. 文字列補間

セリフブロック内で `{式}` を使用すると、式の評価結果に置換される。

```ksc
name = "太郎"
score = 100

#narrator
{name}のスコアは{score}点です。
合計は{score + 50}点です。
#
```

- 式が `null` / `undefined` の場合は空文字列に置換
- 補間内でエラーが発生した場合は即座に実行停止

## 8. 予約語一覧

```
true  false  if  else  while  def  sub  return  choice
```

Tokenizer はこれらをキーワードとして認識する。ただし `while` は現在未実装。

## 9. 組み込み関数名（予約）

以下の名前はユーザー定義関数・サブルーチン名に使用できない：

```
bg  ch  ch_anim  ch_hide  ch_clear  bgm  bgm_stop
se  voice  wait  waitclick  timeline  timeline_play
battle  jump  call  ret
```

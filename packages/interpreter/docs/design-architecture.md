# アーキテクチャ設計書

> Generated by Claude Opus 4.6

## 1. モジュール構成

```
src/
├── core/               # コアモジュール
│   ├── Interpreter.ts  # メインクラス（実行制御）
│   ├── Parser.ts       # 構文解析（行分類、ブロック検出）
│   ├── Evaluator.ts    # 式評価（再帰下降パーサー）
│   ├── Tokenizer.ts    # 字句解析（トークン分解）
│   └── GameState.ts    # 状態管理（変数、スタック）
├── engine/
│   └── IEngineAPI.ts   # エンジン抽象インターフェース
├── debug/
│   ├── Debugger.ts     # デバッグ機能
│   └── ErrorHandler.ts # エラー処理ユーティリティ
├── types/
│   ├── LineType.ts     # 行種別 enum
│   ├── Token.ts        # トークン型
│   ├── CallFrame.ts    # コールフレーム型
│   ├── Choice.ts       # 選択肢ノード型
│   └── Error.ts        # エラー型
└── index.ts            # 公開 API エクスポート
```

## 2. 依存関係

```
Interpreter
├── Parser           （行分類、構造検出）
├── Evaluator        （式評価、代入実行）
│   └── Tokenizer    （字句解析）
├── GameState        （状態管理）
├── IEngineAPI       （プラットフォーム操作）
├── Debugger         （デバッグ機能）
└── ErrorHandler     （エラー処理）

外部依存: なし（devDependencies のみ）
```

### 2.1 依存方向の原則

- `core/` → `types/`, `engine/`, `debug/` への依存はあり
- `engine/` → 他モジュールへの依存なし（純粋なインターフェース定義）
- `types/` → 他モジュールへの依存なし（純粋な型定義）
- `debug/` → `types/` への依存のみ

## 3. 実行パイプライン

### 3.1 全体フロー

```
.ksc テキスト
    │
    ▼
┌──────────────────────────────────────────────┐
│ Interpreter.run(script)                       │
│                                               │
│  1. テキスト → 行分割 (split("\n"))            │
│  2. ラベルマップ構築 (Parser.buildLabelMap)     │
│  3. 関数/サブルーチン定義インデックス化          │
│  4. メインループ開始                           │
│                                               │
│  while (running && pc < lines.length)         │
│    └── step()                                 │
└──────────────────────────────────────────────┘
```

### 3.2 step() の処理フロー

```
step()
  │
  ├── 空行/コメント → スキップ
  ├── def/sub定義 → ブロック末尾までスキップ
  │
  └── Parser.classifyLine(line)
       │
       ├── DialogueStart → handleDialogue()
       │     ├── Parser.extractSpeaker()
       │     ├── テキスト行を収集（# まで）
       │     ├── Evaluator.interpolate()  ← 文字列補間
       │     └── IEngineAPI.showDialogue()
       │
       ├── DialogueEnd → スキップ
       │
       ├── Label → スキップ
       │
       └── Expression → handleExpression()
             │
             ├── return文 → handleReturn()
             ├── if文 → handleIf()
             ├── choice構文 → handleChoice()
             ├── 関数付き代入 → executeUserFunction() + setVar()
             ├── 代入文 → Evaluator.executeAssignment()
             ├── 関数呼び出し → executeBuiltin() or executeUserFunction()
             └── その他の式 → Evaluator.evaluate()
```

### 3.3 式評価フロー

```
式テキスト
  │
  ▼
Tokenizer.tokenize()
  │ Token[]
  ▼
Evaluator.parseExpression()
  ├── parseLogicOr()
  │   ├── parseLogicAnd()
  │   │   ├── parseEquality()
  │   │   │   ├── parseComparison()
  │   │   │   │   ├── parseAddition()
  │   │   │   │   │   ├── parseMultiplication()
  │   │   │   │   │   │   ├── parseUnary()
  │   │   │   │   │   │   │   └── parsePrimary()
  │   │   │   │   │   │   │        ├── Number → parseFloat
  │   │   │   │   │   │   │        ├── String → value
  │   │   │   │   │   │   │        ├── Boolean → true/false
  │   │   │   │   │   │   │        ├── Identifier → state.getVar()
  │   │   │   │   │   │   │        ├── Identifier( → functionCallHandler
  │   │   │   │   │   │   │        └── ( → parseExpression()
```

## 4. 各クラスの責務

### 4.1 Interpreter

- **責務**: スクリプト実行の統括
- **所有**: Parser, Evaluator, GameState, IEngineAPI, Debugger
- **主要メソッド**:
  - `run(script)` — スクリプトの実行開始
  - `stop()` — 実行停止
  - `step()` — 1 行実行
  - `handleDialogue()` — セリフブロック処理
  - `handleExpression()` — 式/文の処理
  - `handleIf()` / `handleChoice()` — 制御構文の処理
  - `executeBuiltin()` — 組み込みコマンド実行
  - `executeUserFunction()` — ユーザー定義関数実行

### 4.2 Parser

- **責務**: テキストの構造解析
- **状態なし**: 静的な解析ロジックのみ（ステートレス）
- **主要メソッド**:
  - `classifyLine()` — 行種別の判定
  - `buildLabelMap()` — ラベルマップの構築
  - `parseChoice()` — choice 構文の解析
  - `parseFunctionDef()` — 関数定義の解析
  - `findBlockEnd()` — ブロック終了位置の検索

### 4.3 Evaluator

- **責務**: 式の評価と代入の実行
- **状態**: Tokenizer インスタンス、現在のトークン列と位置
- **主要メソッド**:
  - `evaluate()` — 式の評価
  - `executeAssignment()` — 代入文の実行
  - `evaluateCondition()` — 条件式の評価
  - `interpolate()` — 文字列補間

### 4.4 GameState

- **責務**: 実行状態の保持
- **状態**: variables, localScopes, callStack, labelMap, functions, subroutines
- **主要メソッド**:
  - `getVar()` / `setVar()` — 変数操作
  - `pushScope()` / `popScope()` — スコープ管理
  - `pushFrame()` / `popFrame()` — コールスタック管理

### 4.5 Debugger

- **責務**: デバッグ機能の提供
- **状態**: ブレークポイント、変数ウォッチ、トレースログ
- **非結合**: Interpreter から `getDebugger()` 経由でアクセス。Interpreter の内部ロジックへの影響は最小限

## 5. 拡張ポイント

| 拡張 | 方法 | 影響範囲 |
|---|---|---|
| 新コマンド追加 | `executeBuiltin()` に case 追加 + IEngineAPI にメソッド追加 | Interpreter + IEngineAPI |
| 新構文追加 | `handleExpression()` に分岐追加 | Interpreter |
| 新演算子追加 | Tokenizer に認識ルール追加 + Evaluator にパースメソッド追加 | Tokenizer + Evaluator |
| 新型追加 | Evaluator の型強制ルール拡張 | Evaluator |
| デバッグ拡張 | Debugger に新機能追加 | Debugger のみ |

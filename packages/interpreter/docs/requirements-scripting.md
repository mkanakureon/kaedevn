# スクリプト言語要求仕様書

> Generated by Claude Opus 4.6

## 1. 概要

本書は .ksc（Kaede Script）言語に求められる機能要件を定義する。各機能の優先度と受入基準を明確にし、実装・テストの指針とする。

## 2. 機能要件

### 2.1 セリフ表示

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | `#キャラ名 ... #` ブロックでセリフを表示する |
| 受入基準 | (1) 話者名が IEngineAPI.showDialogue に渡される (2) 複数行テキストが配列として渡される (3) 空の話者名で地の文として動作する |

```ksc
#hero
こんにちは
元気ですか？
#
```

### 2.2 変数操作

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | 変数の宣言・代入・参照・算術演算 |
| 受入基準 | (1) number, string, boolean リテラルの代入 (2) `+=`, `-=`, `*=`, `/=` 複合代入 (3) 未定義変数アクセスでエラー (4) 関数内ローカルスコープの分離 |

```ksc
score = 0
name = "Player"
flag = true
score += 10
```

### 2.3 条件分岐

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | `if` / `else if` / `else` による条件分岐 |
| 受入基準 | (1) 比較演算子（`==`, `!=`, `>`, `>=`, `<`, `<=`）が動作する (2) 論理演算子（`&&`, `\|\|`, `!`）が動作する (3) ネストされた if をサポート (4) ブロック内でセリフ・コマンドが動作する |

```ksc
if (score >= 80) {
  #narrator
  高得点です！
  #
} else if (score >= 50) {
  #narrator
  まずまずです
  #
} else {
  #narrator
  頑張りましょう
  #
}
```

### 2.4 選択肢

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | `choice` 構文でプレイヤーに選択肢を提示 |
| 受入基準 | (1) 選択肢テキストが IEngineAPI.showChoice に渡される (2) 条件付き選択肢が正しくフィルタされる (3) 選択結果に応じたブロックが実行される (4) 表示可能な選択肢が 0 件でエラー |

```ksc
choice {
  "勉強する" {
    score += 10
  }
  "遊ぶ" {
    affection += 5
  }
  "秘密の選択肢" if (flag == true) {
    jump("secret")
  }
}
```

### 2.5 関数（def）

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | 戻り値を持つ関数の定義と呼び出し |
| 受入基準 | (1) 引数を受け取り、ローカルスコープで束縛 (2) `return expr` で値を返す (3) 戻り値を変数に代入可能 (4) 再帰呼び出し（16 段まで）が動作する (5) 組み込み関数名の使用でエラー |

```ksc
def add(a, b) {
  return a + b
}
result = add(3, 5)
```

### 2.6 サブルーチン（sub）

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | 副作用専用のサブルーチン定義と呼び出し |
| 受入基準 | (1) 引数を受け取り、ローカルスコープで束縛 (2) `return expr` でエラー (3) `return` 単体で早期終了可能 (4) ブロック内でセリフ・コマンドが動作する |

```ksc
sub show_status() {
  #narrator
  現在のスコア: {score}
  #
}
show_status()
```

### 2.7 ラベルとジャンプ

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | ラベル定義と jump/call/ret による制御フロー |
| 受入基準 | (1) `jump()` でラベルに無条件ジャンプ (2) `call()` でスタックに復帰先を保存してジャンプ (3) `ret()` で `call` 元に復帰 (4) 未定義ラベルへの jump/call でエラー (5) 空スタックで ret() でエラー |

### 2.8 文字列補間

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | セリフブロック内の `{式}` を評価結果に置換 |
| 受入基準 | (1) 変数参照が置換される (2) 算術式が評価・置換される (3) null/undefined は空文字列に (4) 評価エラーで実行停止 (5) セリフブロック外では補間しない |

### 2.9 コメント

| 項目 | 内容 |
|---|---|
| 優先度 | **必須** |
| 説明 | `//` で始まる行をコメントとして無視 |
| 受入基準 | (1) コメント行が実行されない (2) 空行が実行されない |

## 3. 将来の拡張候補

| 機能 | 優先度 | 状態 |
|---|---|---|
| `while` ループ | 低 | 予約語のみ（未実装） |
| 配列・オブジェクト型 | 低 | 未計画 |
| `import` / `include`（外部スクリプト読み込み） | 中 | 未計画 |
| カスタム組み込み関数の登録 API | 中 | 設計中 |

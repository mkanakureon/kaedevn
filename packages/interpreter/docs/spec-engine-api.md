# IEngineAPI インターフェース仕様書

> Generated by Claude Opus 4.6

## 1. 概要

`IEngineAPI` はインタプリタとプラットフォーム固有の描画・音声・UI を分離する抽象インターフェースである。Web（PixiJS）、Nintendo Switch、テスト用モック等、プラットフォームごとに実装する。

ソース: `src/engine/IEngineAPI.ts`

## 2. インターフェース定義

```typescript
export interface IEngineAPI {
  // セリフ
  showDialogue(speaker: string, lines: string[]): Promise<void>;

  // 背景
  setBg(name: string, effect?: string): Promise<void>;

  // キャラクター
  showChar(name: string, pose: string, position?: string, fadeMs?: number): Promise<void>;
  showCharAnim(name: string, pose: string, position: string): Promise<void>;
  hideChar(name: string, fadeMs?: number): Promise<void>;
  clearChars(fadeMs?: number): Promise<void>;
  moveChar(name: string, position: string, time: number): Promise<void>;

  // オーディオ
  playBgm(name: string, vol?: number, fadeMs?: number): void;
  stopBgm(): void;
  fadeBgm(time: number): Promise<void>;
  playSe(name: string, vol?: number): void;
  playVoice(name: string): void;

  // タイムライン
  playTimeline(name: string): Promise<void>;

  // バトル
  battleStart(troopId: string): Promise<'win' | 'lose'>;

  // UI
  showChoice(options: ChoiceOption[]): Promise<number>;
  waitForClick(): Promise<void>;
  wait(ms: number): Promise<void>;
}

export interface ChoiceOption {
  text: string;
  condition?: boolean;
}
```

## 3. メソッド詳細

### 3.1 セリフ

#### `showDialogue(speaker, lines)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — ユーザーのクリック待ちを含む |
| 引数 | `speaker: string` — キャラクター名（空文字列は地の文）<br>`lines: string[]` — テキスト行の配列（文字列補間適用済み） |
| 戻り値 | `Promise<void>` |
| 呼び出しタイミング | セリフブロック（`#name ... #`）の終了時に 1 回 |

### 3.2 背景

#### `setBg(name, effect?)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — エフェクト完了まで待機 |
| 引数 | `name: string` — 背景アセット ID<br>`effect?: string` — エフェクト名（`"fade"` 等） |
| 戻り値 | `Promise<void>` |
| 対応コマンド | `bg("school_day")`, `bg("room", "fade")` |

### 3.3 キャラクター

#### `showChar(name, pose, position?, fadeMs?)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — フェード完了まで待機 |
| 引数 | `name: string` — キャラクター名<br>`pose: string` — ポーズ名<br>`position?: string` — 位置（`"left"`, `"center"`, `"right"`）<br>`fadeMs?: number` — フェード時間（ミリ秒） |
| 対応コマンド | `ch("hero", "smile", "center")` |

#### `showCharAnim(name, pose, position)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` |
| 引数 | `name: string` — キャラクター名<br>`pose: string` — アニメーションスラッグ<br>`position: string` — 位置 |
| 対応コマンド | `ch_anim("hero", "attack", "center")` |
| 備考 | ループアニメーション用 |

#### `hideChar(name, fadeMs?)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — フェード完了まで待機 |
| 引数 | `name: string` — キャラクター名<br>`fadeMs?: number` — フェード時間 |
| 対応コマンド | `ch_hide("hero")`, `ch_hide("hero", 500)` |

#### `clearChars(fadeMs?)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` |
| 引数 | `fadeMs?: number` — フェード時間 |
| 対応コマンド | `ch_clear()`, `ch_clear(300)` |
| 備考 | 全キャラクターを一括消去 |

#### `moveChar(name, position, time)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — 移動完了まで待機 |
| 引数 | `name: string` — キャラクター名<br>`position: string` — 移動先<br>`time: number` — 移動時間（ミリ秒） |
| 対応コマンド | `ch("hero", "smile", "right", 500)` |

### 3.4 オーディオ

#### `playBgm(name, vol?, fadeMs?)`

| 項目 | 内容 |
|---|---|
| 同期 | **sync** — 再生開始のみで完了を待たない |
| 引数 | `name: string` — BGM アセット ID<br>`vol?: number` — 音量 0–100<br>`fadeMs?: number` — フェードイン時間 |
| 対応コマンド | `bgm("title_theme")`, `bgm("battle", 80, 1000)` |

#### `stopBgm()`

| 項目 | 内容 |
|---|---|
| 同期 | **sync** |
| 対応コマンド | `bgm_stop()`（引数なし or フェード時間 0） |

#### `fadeBgm(time)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — フェード完了まで待機 |
| 引数 | `time: number` — フェード時間（ミリ秒） |
| 対応コマンド | `bgm_stop(1000)` |
| 備考 | `bgm_stop()` にフェード時間が指定された場合に呼ばれる |

#### `playSe(name, vol?)`

| 項目 | 内容 |
|---|---|
| 同期 | **sync** |
| 引数 | `name: string` — SE アセット ID<br>`vol?: number` — 音量 0–100 |
| 対応コマンド | `se("click")`, `se("explosion", 100)` |

#### `playVoice(name)`

| 項目 | 内容 |
|---|---|
| 同期 | **sync** |
| 引数 | `name: string` — ボイスファイル ID |
| 対応コマンド | `voice("hero_001")` |

### 3.5 タイムライン

#### `playTimeline(name)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — タイムライン完了まで待機 |
| 引数 | `name: string` — タイムライン名 |
| 対応コマンド | `timeline("opening_anim")`, `timeline_play("cutscene1")` |
| 備考 | 現在の Web 実装では未実装 |

### 3.6 バトル

#### `battleStart(troopId)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — バトル終了まで待機 |
| 引数 | `troopId: string` — 敵グループ ID |
| 戻り値 | `Promise<'win' \| 'lose'>` |
| 対応コマンド | `battle("goblin_squad", "win_label", "lose_label")` |
| 備考 | 勝敗に応じてラベルジャンプ。ラベル未指定なら次の行に進む |

### 3.7 UI

#### `showChoice(options)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — ユーザーの選択待ち |
| 引数 | `options: ChoiceOption[]` — 選択肢の配列 |
| 戻り値 | `Promise<number>` — 選択されたインデックス（0 始まり） |
| 備考 | インタプリタ側で条件フィルタ済みの選択肢のみ渡される |

#### `waitForClick()`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — クリック / タップ / ボタン押下まで待機 |
| 対応コマンド | `waitclick()` |

#### `wait(ms)`

| 項目 | 内容 |
|---|---|
| 非同期 | `async` — 指定時間待機 |
| 引数 | `ms: number` — 待機時間（ミリ秒） |
| 対応コマンド | `wait(500)`, `wait(2000)` |

## 4. 最小実装と完全実装

### 4.1 最小実装（必須メソッド）

スクリプトを実行するために最低限必要なメソッド：

```typescript
class MinimalEngine implements IEngineAPI {
  async showDialogue(speaker: string, lines: string[]) { /* テキスト表示 */ }
  async setBg(name: string) { /* no-op 可 */ }
  async showChar(name: string, pose: string) { /* no-op 可 */ }
  async showCharAnim(name: string, pose: string, position: string) { /* no-op 可 */ }
  async hideChar(name: string) { /* no-op 可 */ }
  async clearChars() { /* no-op 可 */ }
  async moveChar(name: string, position: string, time: number) { /* no-op 可 */ }
  playBgm(name: string) { /* no-op 可 */ }
  stopBgm() { /* no-op 可 */ }
  async fadeBgm(time: number) { /* no-op 可 */ }
  playSe(name: string) { /* no-op 可 */ }
  playVoice(name: string) { /* no-op 可 */ }
  async playTimeline(name: string) { /* no-op 可 */ }
  async battleStart(troopId: string) { return 'win'; }
  async showChoice(options: ChoiceOption[]) { return 0; }
  async waitForClick() { /* no-op 可 */ }
  async wait(ms: number) { /* no-op 可 */ }
}
```

実際にはすべてのメソッドを実装する必要があるが、`showDialogue` と `showChoice` 以外は no-op（何もしない）で動作する。

### 4.2 公式コンソール実装（ConsoleEngine）

パッケージに `ConsoleEngine` が含まれている。全メソッドを標準出力のテキストに変換する公式リファレンス実装。ソースコード: `src/engine/ConsoleEngine.ts`、詳細: [guide-console-engine.md](guide-console-engine.md)

### 4.3 完全実装

すべてのメソッドでプラットフォーム固有の処理を実装する。Web 実装の例は `packages/web/src/engine/WebEngine.ts` を参照。

## 5. 実装時の注意事項

1. **async メソッドの完了待ち**: `async` メソッドは処理完了まで待機すること。フェードアニメーション中に次のコマンドが実行されてはならない
2. **showChoice の戻り値**: 0 始まりのインデックスを返すこと。範囲外のインデックスは未定義動作
3. **sync メソッドの即時復帰**: `playBgm`, `stopBgm`, `playSe`, `playVoice` は同期メソッドなので、再生開始だけして即座に戻ること
4. **エラー時の挙動**: IEngineAPI メソッド内で発生した例外はインタプリタまで伝播し、スクリプト実行が停止する

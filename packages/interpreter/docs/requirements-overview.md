# 要求仕様書（総合）

> Generated by Claude Opus 4.6

## 1. プロジェクト概要

### 1.1 目的

`@kaedevn/interpreter` は、KSC（Kaede Script）形式のスクリプトを解釈・実行するインタプリタである。ビジュアルノベルのシナリオ記述に特化し、プラットフォーム非依存のアーキテクチャでクロスプラットフォーム対応を実現する。

### 1.2 対象ユーザー

| ユーザー | 用途 |
|---|---|
| **シナリオライター** | .ksc スクリプトでビジュアルノベルのシナリオを記述 |
| **ゲーム開発者** | IEngineAPI を実装してインタプリタを自分のゲームエンジンに組み込む |
| **エンジン開発者** | インタプリタのコアを拡張・カスタマイズ |
| **ツール開発者** | デバッグ API を利用してスクリプトエディタ・デバッガを構築 |

### 1.3 利用シーン

- ビジュアルノベルのシナリオ実行（メイン用途）
- RPG のイベントスクリプト実行
- インタラクティブフィクションの実行
- スクリプトのデバッグ・テスト

## 2. 機能要件

### 2.1 スクリプト実行

| ID | 要件 | 優先度 |
|---|---|---|
| FR-01 | .ksc スクリプトのロードと逐次実行 | 必須 |
| FR-02 | セリフブロックの表示（話者名+テキスト行） | 必須 |
| FR-03 | ラベル定義とジャンプ（`jump`, `call`, `ret`） | 必須 |
| FR-04 | 変数の代入・参照・算術演算（`=`, `+=`, `-=`, `*=`, `/=`） | 必須 |
| FR-05 | 条件分岐（`if` / `else if` / `else`） | 必須 |
| FR-06 | 選択肢表示と分岐（`choice`） | 必須 |
| FR-07 | 関数定義と呼び出し（`def` — 戻り値あり） | 必須 |
| FR-08 | サブルーチン定義と呼び出し（`sub` — 戻り値なし） | 必須 |
| FR-09 | 文字列補間（セリフブロック内の `{式}`） | 必須 |
| FR-10 | コメント（`//`） | 必須 |

### 2.2 組み込みコマンド

| ID | 要件 | 優先度 |
|---|---|---|
| FR-11 | 背景制御（`bg`） | 必須 |
| FR-12 | キャラクター表示・非表示・移動（`ch`, `ch_hide`, `ch_clear`, `ch_anim`） | 必須 |
| FR-13 | 音声制御（`bgm`, `bgm_stop`, `se`, `voice`） | 必須 |
| FR-14 | 待機（`wait`, `waitclick`） | 必須 |
| FR-15 | タイムライン実行（`timeline`, `timeline_play`） | 任意 |
| FR-16 | バトル開始（`battle`） | 任意 |

### 2.3 デバッグ機能

| ID | 要件 | 優先度 |
|---|---|---|
| FR-17 | ブレークポイント（行指定、条件付き） | 推奨 |
| FR-18 | 変数ウォッチ（変更履歴の記録） | 推奨 |
| FR-19 | ステップ実行（over/into/out） | 推奨 |
| FR-20 | トレースログ（関数呼び出し・変数変更の記録） | 推奨 |
| FR-21 | デバッグイベントリスナー | 推奨 |

### 2.4 エラーハンドリング

| ID | 要件 | 優先度 |
|---|---|---|
| FR-22 | エラー種別の分類（SyntaxError, ReferenceError, TypeError, RuntimeError, StackOverflow） | 必須 |
| FR-23 | 行番号付きエラーメッセージ | 必須 |
| FR-24 | Levenshtein 距離による修正候補の提案 | 推奨 |
| FR-25 | スタックトレースの出力 | 推奨 |
| FR-26 | エラーコンテキスト（該当行の前後表示） | 推奨 |

## 3. 非機能要件

### 3.1 パフォーマンス

| ID | 要件 | 基準 |
|---|---|---|
| NFR-01 | 100 行スクリプトの実行 | 1 秒以内 |
| NFR-02 | 100 変数の操作 | 500ms 以内 |
| NFR-03 | 式評価（単純な算術） | 1ms 以内 |

### 3.2 移植性

| ID | 要件 |
|---|---|
| NFR-04 | プラットフォーム固有の API を直接呼び出さない（IEngineAPI を経由） |
| NFR-05 | Node.js / ブラウザ / Deno で動作する ESM パッケージ |
| NFR-06 | 外部依存ゼロ（devDependencies のみ） |

### 3.3 セキュリティ

| ID | 要件 |
|---|---|
| NFR-07 | スクリプトから任意の JS コードを実行できない（`eval` 不使用） |
| NFR-08 | ファイルシステム・ネットワークへの直接アクセスを持たない |
| NFR-09 | 再帰深度制限（16 段）によるスタックオーバーフロー防止 |

### 3.4 保守性

| ID | 要件 |
|---|---|
| NFR-10 | TypeScript で型安全に実装 |
| NFR-11 | モジュール分離（core / engine / types / debug） |
| NFR-12 | 134 件以上のテストケース |

## 4. 制約条件

| 制約 | 詳細 |
|---|---|
| 対象言語 | TypeScript 5.3+ |
| ランタイム | Node.js 20+、モダンブラウザ |
| モジュール形式 | ESM（`"type": "module"`） |
| 型システム | number / string / boolean / null の 4 型のみ |
| 再帰上限 | 関数・サブルーチンの再帰は 16 段まで |
| スクリプト文法 | 1 行 = 1 命令（複数命令の 1 行記述は不可） |
| 組み込みコマンドの予約 | 17 個の組み込み関数名はユーザー定義関数名に使用不可 |

## 5. 用語

→ [glossary.md](glossary.md) を参照
